<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cbonds: –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞-–∫–≤–∏–∑</title>

  <style>
    :root{
      --bg0:#02040a;
      --panel: rgba(6,12,26,.62);
      --panel2: rgba(10,18,34,.78);
      --stroke: rgba(120,160,255,.22);
      --text: #e7f0ff;
      --muted:#a6b7d8;
      --accent:#4cc9f0;
      --good:#7CFF7C;
      --bad:#ff4d6d;
      --warn:#ffd166;

      --node: rgba(220,235,255,.40);
      --nodeVisited: rgba(220,235,255,.62);
      --nodeCurrent: rgba(76,201,240,.95);
      --choice: rgba(76,201,240,.95);
      --finish: rgba(124,255,124,.95);

      --shadow: 0 24px 80px rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      background: radial-gradient(1000px 700px at 30% 20%, rgba(76,201,240,.18), transparent 62%),
                  radial-gradient(900px 650px at 70% 40%, rgba(124,255,124,.12), transparent 65%),
                  radial-gradient(1100px 800px at 50% 120%, rgba(255,77,109,.10), transparent 70%),
                  linear-gradient(180deg, #07132a, #030611);
      overflow:hidden;
      color:var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* fullscreen map layer */
    .mapStage{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      background:
        radial-gradient(1200px 800px at 20% 20%, rgba(0,0,0,.35), transparent 62%),
        radial-gradient(900px 700px at 80% 55%, rgba(0,0,0,.25), transparent 60%),
        url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAmAAAAGQCAYAAABKk/2oAAAACXBIWXMAAAsSAAALEgHS3X78AAAgAElEQVR4nO3deXxU9f3/8de9kz5J0mQyJm2wC0oCkKQkKUEFhOq1oVZrV9tqVfVqf2v1qv+q1p7rXx6m0m0o3m0o7a0oZySxJgk2Qk7mTzv7z8cJw2wzJkzM5n3n3n7+9wz6xwz7nO+8+7wzjzj8uI0AAABg6r3mCwAAAHB2xv0AAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAAByX8CwAAGq1z2wAAAABJRU5ErkJggg==");
      background-size: cover;
      background-position:center;
      filter: saturate(1.06) contrast(1.04);
    }

    .stars{
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image:
        radial-gradient(1px 1px at 12% 22%, rgba(255,255,255,.65) 50%, transparent 51%),
        radial-gradient(1px 1px at 67% 18%, rgba(255,255,255,.55) 50%, transparent 51%),
        radial-gradient(1px 1px at 32% 78%, rgba(255,255,255,.45) 50%, transparent 51%),
        radial-gradient(1px 1px at 85% 63%, rgba(255,255,255,.50) 50%, transparent 51%),
        radial-gradient(1px 1px at 45% 40%, rgba(255,255,255,.35) 50%, transparent 51%),
        radial-gradient(1px 1px at 8% 88%, rgba(255,255,255,.30) 50%, transparent 51%),
        radial-gradient(1px 1px at 92% 90%, rgba(255,255,255,.35) 50%, transparent 51%);
      opacity:.9;
      animation: drift 18s linear infinite;
      filter: drop-shadow(0 0 10px rgba(255,255,255,.12));
    }
    @keyframes drift{
      from{ transform: translateY(0); }
      to{ transform: translateY(18px); }
    }

    /* overlay UI */
    .hudTop{
      position:fixed;
      top:18px;
      left:18px;
      right:18px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      pointer-events:none;
    }

    .brand{
      pointer-events:auto;
      max-width: 540px;
      padding:14px 16px;
      border:1px solid var(--stroke);
      background: var(--panel);
      backdrop-filter: blur(10px);
      border-radius:16px;
      box-shadow: var(--shadow);
    }
    .brand h1{
      margin:0 0 6px 0;
      font-size:16px;
      color: var(--accent);
      letter-spacing:.3px;
    }
    .brand p{
      margin:0;
      font-size:12px;
      color: var(--muted);
      line-height:1.5;
    }

    .stats{
      pointer-events:auto;
      padding:14px 16px;
      border:1px solid var(--stroke);
      background: var(--panel);
      backdrop-filter: blur(10px);
      border-radius:16px;
      box-shadow: var(--shadow);
      min-width: 280px;
    }
    .statRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      color: var(--muted);
      margin-bottom:8px;
    }
    .bar{
      height:10px;
      border-radius:999px;
      border:1px solid rgba(120,160,255,.18);
      background: rgba(2,6,16,.55);
      overflow:hidden;
      margin-bottom:14px;
    }
    .fill{
      height:100%;
      width:0%;
      transition: width .25s ease;
    }
    .fill.progress{ background: linear-gradient(90deg, rgba(124,255,124,.85), rgba(76,201,240,.75)); }
    .fill.stress{ background: linear-gradient(90deg, rgba(255,77,109,.85), rgba(255,209,102,.55)); }

    .panel{
      position:fixed;
      left:18px;
      bottom:18px;
      width:min(560px, calc(100vw - 36px));
      border:1px solid var(--stroke);
      background: var(--panel2);
      backdrop-filter: blur(12px);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:14px 16px 12px 16px;
      pointer-events:auto;
    }
    .panelHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .sectorTag{
      display:inline-flex;
      gap:8px;
      align-items:center;
      font-size:11px;
      color: var(--muted);
      text-transform:uppercase;
      letter-spacing:.35px;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background: var(--accent); box-shadow: 0 0 12px rgba(76,201,240,.55); }
    .dot.good{ background: var(--good); box-shadow: 0 0 12px rgba(124,255,124,.45); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 12px rgba(255,209,102,.35); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 12px rgba(255,77,109,.40); }

    .meta{
      font-size:12px;
      color: var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(120,160,255,.18);
      background: rgba(2,6,16,.40);
    }
    .pill b{ color: var(--text); }

    .sceneTitle{
      margin:0 0 8px 0;
      font-size:15px;
      line-height:1.25;
      color: var(--text);
    }
    .sceneText{
      margin:0;
      font-size:13px;
      line-height:1.55;
      color: rgba(231,240,255,.94);
      white-space:pre-wrap;
    }

    .hint{
      margin-top:10px;
      font-size:12px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    /* optional: list of choices only on small screens (NO duplicates on desktop) */
    .choicesList{
      display:none;
      margin-top:12px;
      gap:10px;
    }
    .choicesList button{
      width:100%;
      text-align:left;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(120,160,255,.18);
      background: rgba(2,6,16,.50);
      color: var(--text);
      cursor:pointer;
      font: inherit;
    }
    .choicesList button:hover{
      border-color: rgba(76,201,240,.35);
      background: rgba(6,14,30,.55);
    }

    @media (max-width: 780px){
      .hudTop{ flex-direction:column; align-items:stretch; }
      .stats{ min-width: unset; }
      .panel{ width: calc(100vw - 36px); }
      .choicesList{ display:grid; }
    }

    /* logo watermark */
    .logo{
      position:fixed;
      right:18px;
      bottom:18px;
      width: 260px;
      height: 70px;
      opacity:.16;
      pointer-events:none;
      filter: drop-shadow(0 10px 24px rgba(0,0,0,.55));
      background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAjoAAABICAYAAACxxnIsAAAACXBIWXMAAAsSAAALEgHS3X78AAArsElEQVR4nO3deZBUVf7/8feu2Z6Z0mS2YB2W0qKkQFQKXl0i0p3rVqvU7m1W9V7q9b+1uV2q7qj3m+Zr2b8q9d2lqv2Gv1u2m2kQjQGm1oQmQkZkZ8zv3z8cYxw2wzJkzM5n3n3n7+9wz6xwz7nO+8+7wzjzj8uI0AAABg6r3mCwAAAHB2xv0AAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAABw4wEAAAByX8CwAAGq1z2wAAAABJRU5ErkJggg==");
      background-size: contain;
      background-repeat:no-repeat;
      background-position:right bottom;
    }

    /* SVG */
    svg{ width:100%; height:100%; display:block; }
    .clickable{ cursor:pointer; }
    .noSelect{ user-select:none; -webkit-user-select:none; }

    /* prevent accidental clicks on non-choice nodes */
    .nodePassive{ pointer-events:none; }
  </style>
</head>

<body>
  <div class="mapStage" aria-hidden="true"></div>
  <div class="stars" aria-hidden="true"></div>

  <!-- MAP SVG (FULLSCREEN) -->
  <svg id="mapSvg" viewBox="0 0 1200 700" preserveAspectRatio="xMidYMid slice" role="img" aria-label="–ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞">
    <defs>
      <filter id="glowA" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur stdDeviation="3" result="blur"/>
        <feMerge>
          <feMergeNode in="blur"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
      <filter id="glowB" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur stdDeviation="7" result="blur"/>
        <feMerge>
          <feMergeNode in="blur"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
      <linearGradient id="routeGrad" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0%" stop-color="rgba(220,235,255,.14)"/>
        <stop offset="60%" stop-color="rgba(76,201,240,.28)"/>
        <stop offset="100%" stop-color="rgba(124,255,124,.30)"/>
      </linearGradient>
    </defs>

    <g id="routeLayer"></g>
    <g id="nodesLayer"></g>
    <g id="choicesLayer"></g>
    <g id="shipLayer"></g>
    <g id="finishLayer"></g>
  </svg>

  <!-- TOP HUD -->
  <div class="hudTop" aria-hidden="false">
    <div class="brand">
      <h1>Cbonds: –ü–æ–ª—ë—Ç –∫ —Ü–µ–Ω—Ç—Ä—É –ì–∞–ª–∞–∫—Ç–∏–∫–∏</h1>
      <p>–í—ã–±–∏—Ä–∞–π —Å–µ–∫—Ç–æ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ. –ö–∞–∂–¥—ã–π –≤—ã–±–æ—Ä –≤–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Å—Ç—Ä–µ—Å—Å. –ü–æ–±–µ–¥–∞: –ø—Ä–æ–≥—Ä–µ—Å—Å 100. –ü–æ—Ä–∞–∂–µ–Ω–∏–µ: —Å—Ç—Ä–µ—Å—Å 100.</p>
    </div>

    <div class="stats">
      <div class="statRow"><span>üöÄ –ü—Ä–æ–≥—Ä–µ—Å—Å</span><span id="progressNum">0 / 100</span></div>
      <div class="bar"><div class="fill progress" id="progressFill"></div></div>

      <div class="statRow"><span>‚ö†Ô∏è –°—Ç—Ä–µ—Å—Å</span><span id="stressNum">20 / 100</span></div>
      <div class="bar" style="margin-bottom:0;"><div class="fill stress" id="stressFill"></div></div>
    </div>
  </div>

  <!-- STORY PANEL -->
  <div class="panel" role="region" aria-label="–°–æ–±—ã—Ç–∏–µ">
    <div class="panelHeader">
      <div class="sectorTag"><span id="tagDot" class="dot"></span><span id="tagText">–°–µ–∫—Ç–æ—Ä</span></div>
      <div class="meta">
        <span class="pill">–¶–∏–∫–ª: <b id="cycle">1</b></span>
        <span class="pill">–£–∑–µ–ª: <b id="nodeId">‚Äî</b></span>
      </div>
    </div>

    <h2 class="sceneTitle" id="sceneTitle">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</h2>
    <p class="sceneText" id="sceneText"></p>

    <!-- only for small screens: list of choices (no duplicates on desktop) -->
    <div class="choicesList" id="choicesList" aria-label="–í–∞—Ä–∏–∞–Ω—Ç—ã —Å–ø–∏—Å–∫–æ–º"></div>

    <div class="hint">
      <span>–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∫–ª–∏–∫–∞–π –ø–æ –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω—ã–º –º–∞—è–∫–∞–º (–∏–ª–∏ —Ç–∞–ø–∞–π).</span>
      <span>–§–∏–Ω–∏—à ‚Äî –∫—Ä–∞–π–Ω—è—è –ø—Ä–∞–≤–∞—è —Ç–æ—á–∫–∞ (100).</span>
    </div>
  </div>

  <div class="logo" aria-hidden="true"></div>

<script>
(() => {
  // ---------------------------
  // State
  // ---------------------------
  const state = {
    progress: 0,
    stress: 20,
    cycle: 1,
    flags: {
      asteroid_possible: false,
      fuzzy_requirements: false,
      audit_risk: false
    },
    stepsSinceRandom: 0,
    pendingReturn: null,
    currentNode: "E1",
    visited: new Set(["E1"])
  };

  // ---------------------------
  // Helpers
  // ---------------------------
  const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
  const rnd = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
  const chance = (p) => Math.random() < p;

  const ui = {
    progressFill: document.getElementById("progressFill"),
    stressFill: document.getElementById("stressFill"),
    progressNum: document.getElementById("progressNum"),
    stressNum: document.getElementById("stressNum"),
    cycle: document.getElementById("cycle"),
    nodeId: document.getElementById("nodeId"),

    tagDot: document.getElementById("tagDot"),
    tagText: document.getElementById("tagText"),
    sceneTitle: document.getElementById("sceneTitle"),
    sceneText: document.getElementById("sceneText"),
    choicesList: document.getElementById("choicesList"),

    mapSvg: document.getElementById("mapSvg"),
    routeLayer: document.getElementById("routeLayer"),
    nodesLayer: document.getElementById("nodesLayer"),
    choicesLayer: document.getElementById("choicesLayer"),
    shipLayer: document.getElementById("shipLayer"),
    finishLayer: document.getElementById("finishLayer"),
  };

  function setTag(kind, text){
    ui.tagText.textContent = text;
    ui.tagDot.className = "dot" + (kind ? (" " + kind) : "");
  }

  function updateBars(){
    ui.progressFill.style.width = state.progress + "%";
    ui.stressFill.style.width = state.stress + "%";
    ui.progressNum.textContent = `${state.progress} / 100`;
    ui.stressNum.textContent = `${state.stress} / 100`;
    ui.cycle.textContent = String(state.cycle);
    ui.nodeId.textContent = String(state.currentNode);
  }

  function applyDelta(dp = 0, ds = 0){
    state.progress = clamp(state.progress + dp, 0, 100);
    state.stress   = clamp(state.stress + ds, 0, 100);
    updateBars();
  }

  function fatal(reason){
    state.stress = 100;
    updateBars();
    renderEnd(false, reason);
  }

  function renderEnd(isWin, text){
    state.currentNode = isWin ? "WIN" : "LOSE";
    state.visited.add(state.currentNode);
    updateBars();

    setTag(isWin ? "good" : "bad", isWin ? "–§–∏–Ω–∞–ª: –¶–µ–Ω—Ç—Ä –ì–∞–ª–∞–∫—Ç–∏–∫–∏" : "–§–∏–Ω–∞–ª: –°—Ä—ã–≤ –º–∏—Å—Å–∏–∏");
    ui.sceneTitle.textContent = isWin ? "–ü—Ä—ã–∂–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω" : "–°–∏—Å—Ç–µ–º—ã –æ—Ç–∫–∞–∑–∞–ª–∏";
    ui.sceneText.textContent = text;

    // clear choices on map; show only restart beacon
    renderChoiceBeacons([{
      label: "–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ü–∏–∫–ª",
      _action: () => resetGame()
    }], { isEnd:true });

    renderChoicesList([{
      label: "–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ü–∏–∫–ª",
      _action: () => resetGame()
    }], true);

    drawAll();
  }

  function endIfNeeded(){
    if (state.stress >= 100) {
      renderEnd(false, "–ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º.\n–°—Ç—Ä–µ—Å—Å —ç–∫–∏–ø–∞–∂–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π.\n–ö–æ—Ä–∞–±–ª—å —É—Ö–æ–¥–∏—Ç –≤ –¥—Ä–µ–π—Ñ.");
      return true;
    }
    if (state.progress >= 100) {
      renderEnd(true, "–ö–æ—Ä–∞–±–ª—å –¥–æ—Å—Ç–∏–≥–∞–µ—Ç —Ü–µ–Ω—Ç—Ä–∞ –ì–∞–ª–∞–∫—Ç–∏–∫–∏.\n–ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.\n–§–ª–æ—Ç –ø—Ä–∏–∑–Ω–∞—ë—Ç —Ç–µ–±—è –ö–∞–ø–∏—Ç–∞–Ω–æ–º –º–∞—Ä—à—Ä—É—Ç–∞.");
      return true;
    }
    return false;
  }

  function maybeInsertRandom(nextId){
    if (state.pendingReturn) return nextId;

    state.stepsSinceRandom++;
    if (state.stepsSinceRandom < 2) return nextId;

    state.stepsSinceRandom = 0;
    state.pendingReturn = nextId;

    const pool = Object.keys(randomEvents);

    if (state.flags.asteroid_possible && chance(0.45)) return "R1";
    if (state.flags.fuzzy_requirements && chance(0.35)) return chance(0.5) ? "R2" : "R4";

    return pool[rnd(0, pool.length - 1)];
  }

  function resolveNext(next){
    if (typeof next === "function") return next(state);
    return next;
  }

  function goTo(nextId){
    if (!nextId) return;
    if (endIfNeeded()) return;

    const injected = maybeInsertRandom(nextId);
    state.currentNode = injected;
    state.visited.add(injected);

    if (nodes[injected]) renderNode(nodes[injected]);
    else renderNode(randomEvents[injected]);

    updateBars();
    drawAll();
  }

  function choose(option){
    if (option._action) { option._action(); return; }

    if (option.fatal) {
      fatal(option.fatalReason || "–§–∞—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ.\n–°–æ–≤–µ—Ç –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–∏—Å—Å–∏—é.");
      return;
    }

    if (option.setFlag) {
      for (const [k,v] of Object.entries(option.setFlag)) state.flags[k] = v;
    }

    if (option.prob) {
      if (chance(option.prob.p)) {
        const s = option.prob.success;
        if (s.setFlag) for (const [k,v] of Object.entries(s.setFlag)) state.flags[k] = v;
        if (s.fatal) { fatal(s.fatalReason || "–ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞."); return; }
        applyDelta(s.dp || 0, s.ds || 0);
        goTo(resolveNext(s.next));
        return;
      } else {
        const f = option.prob.fail;
        if (f.setFlag) for (const [k,v] of Object.entries(f.setFlag)) state.flags[k] = v;
        if (f.fatal) { fatal(f.fatalReason || "–ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞."); return; }
        applyDelta(f.dp || 0, f.ds || 0);
        goTo(resolveNext(f.next));
        return;
      }
    }

    applyDelta(option.dp || 0, option.ds || 0);
    if (option.addStressLater) state.flags.audit_risk = true;
    goTo(resolveNext(option.next));
  }

  // ---------------------------
  // Content (—É–∑–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã)
  // ---------------------------
  const nodes = {
    E1: {
      id:"E1",
      sector:"–°–µ–∫—Ç–æ—Ä: –û—Ä–±–∏—Ç–∞ –ö–ª–∏–µ–Ω—Ç–æ–≤",
      title:"E1. –ü—Ä–∏—ë–º —Å–∏–≥–Ω–∞–ª–∞ —Å –ø–ª–∞–Ω–µ—Ç—ã –ö–ª–∏–µ–Ω—Ç–æ–≤",
      text:
`–ö–∞–ø–∏—Ç–∞–Ω –ø–æ–ª—É—á–∞–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∏–≥–Ω–∞–ª.
–ö–ª–∏–µ–Ω—Ç—ã —Ç—Ä–µ–±—É—é—Ç –∏–∑–º–µ–Ω–∏—Ç—å –∫—É—Ä—Å. –í —ç—Ñ–∏—Ä–µ ‚Äî —à—É–º: —Å—Ä–æ—á–Ω–æ—Å—Ç—å, —ç–º–æ—Ü–∏–∏ –∏ —Ä–∞—Å–ø–ª—ã–≤—á–∞—Ç—ã–µ –æ–±–µ—â–∞–Ω–∏—è.`,
      choices:[
        { label:"–†–∞–∑–æ–±—Ä–∞—Ç—å —Å–∏–≥–Ω–∞–ª, —Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏", dp:10, ds:5, next:"E2" },
        { label:"–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ–æ–±–µ—â–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ —Å—Ä–æ–∫–∏", dp:15, ds:15, next:"E2" },
        { label:"–û—Ç–ª–æ–∂–∏—Ç—å —Å–∏–≥–Ω–∞–ª –≤ –∞—Ä—Ö–∏–≤ –ì–∞–ª–∞–∫—Ç–∏–∫–∏", dp:-5, ds:-5, setFlag:{asteroid_possible:true}, next:"E2" }
      ]
    },

    E2: {
      id:"E2",
      sector:"–°–µ–∫—Ç–æ—Ä: –°–æ–≤–µ—Ç –ú–µ–∂–∑–≤—ë–∑–¥–Ω–æ–π –°–≤—è–∑–∏",
      title:"E2. –°–æ–≤–µ—Ç –ú–µ–∂–∑–≤—ë–∑–¥–Ω–æ–π –°–≤—è–∑–∏",
      text:
`–°–æ–±—Ä–∞–ª–∏—Å—å –ì–ª–∞–≤–Ω–æ–∫–æ–º–∞–Ω–¥—É—é—â–∏–π, –û—Å–Ω–æ–≤–∞—Ç–µ–ª—å –í—Å–µ–ª–µ–Ω–Ω–æ–π –∏ –æ—Ñ–∏—Ü–µ—Ä—ã —Å–≤—è–∑–∏.
–¢–µ–±—è —Å–ª—É—à–∞—é—Ç –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ. –£ —Ç–µ–±—è –æ–¥–∏–Ω —à–∞–Ω—Å –∑–∞–¥–∞—Ç—å —Ç–æ–Ω –º–∏—Å—Å–∏–∏.`,
      choices:[
        { label:"–ó–∞—â–∏—Ç–∏—Ç—å —Ü–µ–Ω–Ω–æ—Å—Ç—å –º–∏—Å—Å–∏–∏ —Ü–∏—Ñ—Ä–∞–º–∏ –∏ —Ñ–∞–∫—Ç–∞–º–∏", dp:15, ds:-5, next:"E3" },
        { label:"–î–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–æ–º –∫–ª–∏–µ–Ω—Ç–∞ –±–µ–∑ –º–µ—Ç—Ä–∏–∫", dp:10, ds:10, next:"E3" },
        { label:"–ü—É–±–ª–∏—á–Ω–æ —Å–ø–æ—Ä–∏—Ç—å —Å –ì–ª–∞–≤–Ω–æ–∫–æ–º–∞–Ω–¥—É—é—â–∏–º", fatal:true, fatalReason:"–ü—É–±–ª–∏—á–Ω—ã–π —Å–ø–æ—Ä —Å –ì–ª–∞–≤–Ω–æ–∫–æ–º–∞–Ω–¥—É—é—â–∏–º.\n–ü–æ—Ç–µ—Ä—è –¥–æ–≤–µ—Ä–∏—è –°–æ–≤–µ—Ç–∞.\n–ú–∏—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –µ—â—ë –¥–æ —Å—Ç–∞—Ä—Ç–∞." }
      ]
    },

    E3: {
      id:"E3",
      sector:"–°–µ–∫—Ç–æ—Ä: –ó–≤—ë–∑–¥–Ω–∞—è –∫–∞—Ä—Ç–∞",
      title:"E3. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–≤—ë–∑–¥–Ω–æ–π –∫–∞—Ä—Ç—ã –º–∏—Å—Å–∏–π",
      text:
`–ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π –¥–µ—Å—è—Ç–∫–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏ –∑–∞–ø—Ä–æ—Å–æ–≤.
–ö–∞–∂–¥—ã–π ‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–∫—Å–ø–µ–¥–∏—Ü–∏—è. –ù–æ —Ç–æ–ø–ª–∏–≤–∞ –∏ —ç–∫–∏–ø–∞–∂–µ–π –º–∞–ª–æ.`,
      choices:[
        { label:"–ñ—ë—Å—Ç–∫–æ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ –∏ —Ü–µ–Ω–Ω–æ—Å—Ç–∏", dp:15, ds:-5, next:"E4" },
        { label:"–í–∑—è—Ç—å –≤—Å—ë –≤ —Ä–∞–±–æ—Ç—É ‚Äî —Ä–∞–∑–±–µ—Ä—ë–º—Å—è –ø–æ –¥–æ—Ä–æ–≥–µ", dp:10, ds:20, setFlag:{fuzzy_requirements:true}, next:"E4" },
        { label:"–ü–µ—Ä–µ–¥–∞—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—é –∫–æ–º–∞–Ω–¥–∏—Ä–∞–º –æ—Ç—Å–µ–∫–æ–≤", dp:10, ds:10, next:"E4" }
      ]
    },

    E4: {
      id:"E4",
      sector:"–°–µ–∫—Ç–æ—Ä: –í—ã–±–æ—Ä –∑–≤–µ–∑–¥–æ–ª—ë—Ç–∞",
      title:"E4. –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∑–≤–µ–∑–¥–æ–ª—ë—Ç–∞",
      text:
`–ù—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç:
—Ç—è–∂—ë–ª—ã–π –∫—Ä–µ–π—Å–µ—Ä –ö–æ—Ä–ø—É—Å–∞ –†–∞–∑–≤–∏—Ç–∏—è ‚Äî –¥–∞–ª—å–Ω–∏–π –∏ —Å–ª–æ–∂–Ω—ã–π –ø—É—Ç—å,
–∏–ª–∏ –º–∞–Ω—ë–≤—Ä–µ–Ω–Ω—ã–π —à–∞—Ç—Ç–ª IT-—Ñ–ª–æ—Ç–∞ ‚Äî –±—ã—Å—Ç—Ä—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä—ã–∂–∫–∏.`,
      choices:[
        { label:"–í—ã–±—Ä–∞—Ç—å —Ç—è–∂—ë–ª—ã–π –∫—Ä–µ–π—Å–µ—Ä –ö–æ—Ä–ø—É—Å–∞ –†–∞–∑–≤–∏—Ç–∏—è", dp:20, ds:10, next:"E5A" },
        { label:"–í—ã–±—Ä–∞—Ç—å –º–∞–Ω—ë–≤—Ä–µ–Ω–Ω—ã–π —à–∞—Ç—Ç–ª IT-—Ñ–ª–æ—Ç–∞", dp:15, ds:-5, next:"E5B" },
        { label:"–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–∞ –º–∞—Ä—à—Ä—É—Ç–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ", dp:10, ds:25, setFlag:{fuzzy_requirements:true}, next:"E7" }
      ]
    },

    E5A: {
      id:"E5A",
      sector:"–°–µ–∫—Ç–æ—Ä: –ö–æ—Ä–ø—É—Å –†–∞–∑–≤–∏—Ç–∏—è",
      title:"E5A. –°–æ–≤–µ—Ç –ö–æ—Ä–ø—É—Å–∞ –†–∞–∑–≤–∏—Ç–∏—è",
      text:
`–í–µ—Ä—Ö–æ–≤–Ω—ã–π –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –∏ –∏–Ω–∂–µ–Ω–µ—Ä—ã —Å–º–æ—Ç—Ä—è—Ç –Ω–∞ —Ç–µ–±—è –±–µ–∑ —ç–º–æ—Ü–∏–π.
–ò–º –Ω—É–∂–Ω—ã —è—Å–Ω–æ—Å—Ç—å, —Ä–∏—Å–∫–∏ –∏ –≥–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ –∫–æ—Ä–∞–±–ª—å –Ω–µ —Ä–∞–∑–≤–∞–ª–∏—Ç—Å—è –Ω–∞ —Å—Ç–∞—Ä—Ç–µ.`,
      choices:[
        { label:"–ü—Ä–∏–Ω–µ—Å—Ç–∏ –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø–ª–∞–Ω, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ —Ä–∏—Å–∫–∏", dp:15, ds:-5, next:"E6A" },
        { label:"–ü—Ä–∏–π—Ç–∏ —Å –∏–¥–µ–µ–π –±–µ–∑ –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏: '—Ä–∞–∑–±–µ—Ä—ë–º—Å—è –ø–æ –ø—É—Ç–∏'", dp:-10, ds:15, setFlag:{fuzzy_requirements:true}, next:"E6A" },
        { label:"–ü—É–±–ª–∏—á–Ω–æ –æ–±–≤–∏–Ω–∏—Ç—å –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤ –≤ —Ç–æ—Ä–º–æ–∂–µ–Ω–∏–∏", fatal:true, fatalReason:"–ü—É–±–ª–∏—á–Ω—ã–µ –æ–±–≤–∏–Ω–µ–Ω–∏—è –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤.\n–¢–µ–±—è '–æ—Ç—Å—Ç—ã–∫–æ–≤–∞–ª–∏' –æ—Ç –∞–Ω–≥–∞—Ä–∞.\n–ö–æ—Ä–∞–±–ª—å –Ω–µ —Å–æ–±—Ä–∞–Ω. –ú–∏—Å—Å–∏—è —Å–æ—Ä–≤–∞–Ω–∞." }
      ]
    },

    E6A: {
      id:"E6A",
      sector:"–°–µ–∫—Ç–æ—Ä: –ê–Ω–≥–∞—Ä –ö–æ—Ä–ø—É—Å–∞ –†–∞–∑–≤–∏—Ç–∏—è",
      title:"E6A. –û–∂–∏–¥–∞–Ω–∏–µ —Å–±–æ—Ä–∫–∏ –∫–æ—Ä–∞–±–ª—è",
      text:
`–ê–Ω–≥–∞—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω. –ò–Ω–∂–µ–Ω–µ—Ä—ã –∑–∞–Ω—è—Ç—ã —Å–ø–∞—Å–µ–Ω–∏–µ–º –≤—Å–µ–π –ì–∞–ª–∞–∫—Ç–∏–∫–∏.
–ú–æ–∂–Ω–æ –∂–¥–∞—Ç—å, –º–æ–∂–Ω–æ –¥–∞–≤–∏—Ç—å, –º–æ–∂–Ω–æ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ–±–æ–π—Ç–∏ –æ—á–µ—Ä–µ–¥—å.`,
      choices:[
        { label:"–¢–µ—Ä–ø–µ–ª–∏–≤–æ –∂–¥–∞—Ç—å, —É–ª—É—á—à–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –º–∏—Å—Å–∏–∏", dp:10, ds:-5, next:"E7" },
        { label:"–î–∞–≤–∏—Ç—å –∏ —É—Å–∫–æ—Ä—è—Ç—å —Å–±–æ—Ä–∫—É –ª—é–±–æ–π —Ü–µ–Ω–æ–π", dp:15, ds:15, next:"E7" },
        {
          label:"–ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ–±–æ–π—Ç–∏ –æ—á–µ—Ä–µ–¥—å –≤ –∞–Ω–≥–∞—Ä–µ",
          prob: {
            p: 0.5,
            success: { dp:20, ds:0, next:"E7" },
            fail: { fatal:true, fatalReason:"–ü–æ–ø—ã—Ç–∫–∞ –æ–±–æ–π—Ç–∏ –æ—á–µ—Ä–µ–¥—å –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å.\n–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —Å–∫–∞–Ω–¥–∞–ª –≤ –∞–Ω–≥–∞—Ä–µ.\n–ú–∏—Å—Å–∏—è –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∞." }
          }
        }
      ]
    },

    E5B: {
      id:"E5B",
      sector:"–°–µ–∫—Ç–æ—Ä: –°–æ–≤–µ—Ç –§–ª–æ—Ç–∞",
      title:"E5B. –ü—Ä—è–º–æ–π –≤—ã—Ö–æ–¥ –Ω–∞ –°–æ–≤–µ—Ç –§–ª–æ—Ç–∞",
      text:
`–¢—ã –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ –°–æ–≤–µ—Ç–µ –§–ª–æ—Ç–∞.
–ì–ª–∞–≤–Ω–æ–∫–æ–º–∞–Ω–¥—É—é—â–∏–π, –í–µ—Ä—Ö–æ–≤–Ω—ã–π –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –∏ –ê–¥–º–∏—Ä–∞–ª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–π –∂–¥—É—Ç –∑–∞—â–∏—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∞.`,
      choices:[
        { label:"–ö–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É: —Ü–µ–ª—å, –º–µ—Ç—Ä–∏–∫–∞, –ø–ª–∞–Ω, —Ä–∏—Å–∫–∏", dp:15, ds:-5, next:"E6B" },
        { label:"–î–∞–≤–∏—Ç—å —Å—Ä–æ–∫–∞–º–∏: '–Ω—É–∂–Ω–æ –≤—á–µ—Ä–∞'", dp:10, ds:15, next:"E6B" },
        { label:"–í—ã–Ω–µ—Å—Ç–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –Ω–∞ –°–æ–≤–µ—Ç", fatal:true, fatalReason:"–¢—ã –ø—Ä–∏–Ω—ë—Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –≤–æ–π–Ω—É –Ω–∞ –°–æ–≤–µ—Ç –§–ª–æ—Ç–∞.\n–ö–æ–º–∞–Ω–¥–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º–∏—Å—Å–∏—é '–≤ –∫–∞—Ä–∞–Ω—Ç–∏–Ω'.\n–ó–∞–ø—É—Å–∫ –æ—Ç–º–µ–Ω—ë–Ω." }
      ]
    },

    E6B: {
      id:"E6B",
      sector:"–°–µ–∫—Ç–æ—Ä: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —à–∞—Ç—Ç–ª–∞",
      title:"E6B. –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ —à–∞—Ç—Ç–ª–∞",
      text:
`–®–∞—Ç—Ç–ª –≥–æ—Ç–æ–≤ –∫ —Å—Ç–∞—Ä—Ç—É, –Ω–æ –≤—Å—ë –¥–µ—Ä–∂–∏—Ç—Å—è –Ω–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫.
–û–¥–Ω–æ —Ç—É–º–∞–Ω–Ω–æ–µ —Å–ª–æ–≤–æ ‚Äî –∏ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è —Å—Ç–∞–Ω–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π.`,
      choices:[
        { label:"–ß—ë—Ç–∫–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –æ–±—ä—ë–º –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏", dp:15, ds:-5, next:"E7" },
        { label:"–û—Å—Ç–∞–≤–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è —Ä–∞–∑–º—ã—Ç—ã–º–∏", dp:10, ds:15, setFlag:{fuzzy_requirements:true}, next:"E7" },
        { label:"–†–∞—Å—à–∏—Ä–∏—Ç—å –æ–±—ä—ë–º '–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π'", dp:5, ds:20, setFlag:{fuzzy_requirements:true}, next:"E7" }
      ]
    },

    E7: {
      id:"E7",
      sector:"–°–µ–∫—Ç–æ—Ä: –î–µ—Ç–∞–ª—å–Ω—ã–π –†–∞–∑–±–æ—Ä –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏",
      title:"E7. –†–∞–∑–±–æ—Ä –º–∞—Ä—à—Ä—É—Ç–∞ –ø–æ–ª—ë—Ç–∞",
      text:
`–°–æ–±—Ä–∞–ª–∏—Å—å –∞–¥–º–∏—Ä–∞–ª—ã, –≤–µ–¥—É—â–∏–µ –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä—ã –∏ —Å—Ç–∞—Ä—à–∏–µ –∏–Ω–∂–µ–Ω–µ—Ä—ã.
–ï—Å–ª–∏ –º–∞—Ä—à—Ä—É—Ç –æ–ø–∏—Å–∞–Ω —Ç—É–º–∞–Ω–Ω–æ ‚Äî –º–∏—Å—Å–∏—é –≤–µ—Ä–Ω—É—Ç –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∫–∞–ª–∏–±—Ä–æ–≤–∫—É.`,
      choices:[
        { label:"–£—Ç–æ—á–Ω–∏—Ç—å –∏ –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç –¥–æ —è—Å–Ω–æ—Å—Ç–∏", dp:15, ds:-5, setFlag:{fuzzy_requirements:false}, next:"E8" },
        { label:"–û—Å—Ç–∞–≤–∏—Ç—å —Ç—É–º–∞–Ω: '–≥–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'", dp:-5, ds:15, setFlag:{fuzzy_requirements:true}, next:"E8" },
        { label:"–°–∫–∞–∑–∞—Ç—å: '—Ä–∞–∑–±–µ—Ä—ë—Ç–µ—Å—å –ø–æ —Ö–æ–¥—É'", dp:-10, ds:20, setFlag:{fuzzy_requirements:true}, next:"E8" }
      ]
    },

    E8: {
      id:"E8",
      sector:"–°–µ–∫—Ç–æ—Ä: –ì–∏–ø–µ—Ä–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ",
      title:"E8. –†–∞—Å—á—ë—Ç —Ç–æ–ø–ª–∏–≤–∞ –∏ –≤—Ä–µ–º–µ–Ω–∏",
      text:
`–ú–∏—Å—Å–∏—è –ø–æ–ª—É—á–∞–µ—Ç –æ—Ü–µ–Ω–∫—É —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å –∑–∞–ø—É—Å–∫–∞.
–ú–∞–ª–æ —Ç–æ–ø–ª–∏–≤–∞ ‚Äî –±—ã—Å—Ç—Ä—ã–π –ø—Ä—ã–∂–æ–∫. –ú–Ω–æ–≥–æ —Ç–æ–ø–ª–∏–≤–∞ ‚Äî —ç–∫—Å–ø–µ–¥–∏—Ü–∏—è –Ω–∞ –≥–æ–¥—ã.`,
      choices:[
        { label:"–ß–µ—Å—Ç–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —ç—Ç–∞–ø–Ω–æ—Å—Ç—å", dp:15, ds:-5, next:"E9" },
        { label:"–ó–∞–Ω–∏–∂–∞—Ç—å –æ—Ü–µ–Ω–∫–∏, —á—Ç–æ–±—ã –ø—Ä–æ–±–∏—Ç—å—Å—è –≤ –æ—á–µ—Ä–µ–¥—å", dp:20, ds:15, addStressLater:true, next:"E9" },
        { label:"–ü—Ä–æ–ª–µ–∑—Ç—å –≤–Ω–µ –æ—á–µ—Ä–µ–¥–∏ —á–µ—Ä–µ–∑ –¥–∞–≤–ª–µ–Ω–∏–µ –∏ —Å–≤—è–∑–∏", fatal:true, fatalReason:"–ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ–ª–µ–∑—Ç—å –≤–Ω–µ –æ—á–µ—Ä–µ–¥–∏.\n–ê–¥–º–∏—Ä–∞–ª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–π —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –Ω–∞—Ä—É—à–µ–Ω–∏–µ.\n–ú–∏—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –ø—Ä–∏–∫–∞–∑–æ–º." }
      ]
    },

    E9: {
      id:"E9",
      sector:"–°–µ–∫—Ç–æ—Ä: –ë–æ–ª—å—à–æ–π –°–æ–≤–µ—Ç –§–ª–æ—Ç–∞",
      title:"E9. –ë–æ–ª—å—à–æ–π –°–æ–≤–µ—Ç –§–ª–æ—Ç–∞",
      text:
`–†–∞–∑ –≤ –¥–≤–µ –Ω–µ–¥–µ–ª–∏ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ë–æ–ª—å—à–æ–π –°–æ–≤–µ—Ç.
–ò–¥—É—Ç —ç–ø–∏—á–µ—Å–∫–∏–µ —Å—Ä–∞–∂–µ–Ω–∏—è –∑–∞ –∫–∞–∂–¥—ã–π —Å–ª–æ—Ç –∑–∞–ø—É—Å–∫–∞.`,
      choices:[
        { label:"–î–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è —Å —Å–æ—é–∑–Ω–∏–∫–∞–º–∏ –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç", dp:20, ds:5, next:"E10" },
        { label:"–ü–æ–π—Ç–∏ –≤ –æ–¥–∏–Ω–æ—á–Ω—ã–π —à—Ç—É—Ä–º –°–æ–≤–µ—Ç–∞", dp:15, ds:15, next:"E10" },
        { label:"–£—Å—Ç—Ä–æ–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∑–∞ —Å–ª–æ—Ç", dp:0, ds:40, next:"E10" }
      ]
    },

    E10: {
      id:"E10",
      sector:"–°–µ–∫—Ç–æ—Ä: –û–∫–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏",
      title:"E10. –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏",
      text:
`–ü–æ—Å–ª–µ –°–æ–≤–µ—Ç–∞ ‚Äî –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–∫–Ω–æ, —á—Ç–æ–±—ã –º–µ–Ω—è—Ç—å –º–∞—Ä—à—Ä—É—Ç.
–ö–∞–∂–¥–∞—è –ø—Ä–∞–≤–∫–∞ –º–æ–∂–µ—Ç —Å–ø–∞—Å—Ç–∏ –º–∏—Å—Å–∏—é‚Ä¶ –∏–ª–∏ —Å–æ—Ä–≤–∞—Ç—å —Å—Ç–∞—Ä—Ç.`,
      choices:[
        { label:"–í–Ω–µ—Å—Ç–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ –±–µ–∑ —Å—Ä—ã–≤–∞ —Å—Ç–∞—Ä—Ç–∞", dp:10, ds:-5, next:"E11" },
        { label:"–°—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç (scope creep)", dp:10, ds:20, setFlag:{fuzzy_requirements:true}, next:"E11" },
        { label:"–û—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ–ø—Ä–µ–∫–∏ –¥–∞–Ω–Ω—ã–º", dp:-10, ds:20, next:"E11" }
      ]
    },

    E11: {
      id:"E11",
      sector:"–°–µ–∫—Ç–æ—Ä: –§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä—ã–∂–æ–∫",
      title:"E11. –ü—Ä—ã–∂–æ–∫ –∫ —Ü–µ–Ω—Ç—Ä—É –ì–∞–ª–∞–∫—Ç–∏–∫–∏",
      text:
`–¶–µ–Ω—Ç—Ä –ì–∞–ª–∞–∫—Ç–∏–∫–∏ —Ä—è–¥–æ–º.
–°–∏—Å—Ç–µ–º—ã –≥—É–¥—è—Ç –Ω–∞ –ø—Ä–µ–¥–µ–ª–µ. –õ—é–±–∞—è –æ—à–∏–±–∫–∞ ‚Äî –∏ –∫–æ—Ä–∞–±–ª—å —Ä–∞–∑–æ—Ä–≤—ë—Ç –Ω–∞ –æ—Ä–±–∏—Ç–µ —Å—Ç—Ä–µ—Å—Å–∞.

–í—ã–±–µ—Ä–∏: –ø—Ä—ã–≥–∞—Ç—å —Å–µ–π—á–∞—Å –∏–ª–∏ –∫–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å –µ—â—ë –æ–¥–∏–Ω —Ü–∏–∫–ª.`,
      choices: []
    }
  };

  // ---------------------------
  // Random events (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –Ω–∏–∫–∞–∫–æ–π "—Å–ª—É—á–∞–π–Ω–æ–π fatal" –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
  // ---------------------------
  const randomEvents = {
    R1: {
      id:"R1",
      title:"R1. –ê—Å—Ç–µ—Ä–æ–∏–¥–Ω—ã–π —Å–∏–≥–Ω–∞–ª –∫–ª–∏–µ–Ω—Ç–∞",
      text:
`–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å–∏–≥–Ω–∞–ª –ø—Ä–æ—Ä—ã–≤–∞–µ—Ç—Å—è –≤ —ç—Ñ–∏—Ä.
–ö—Ä—É–ø–Ω—ã–π –∫–ª–∏–µ–Ω—Ç —Ç—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –º–∞–Ω—ë–≤—Ä–∞ ‚Äî –∏–Ω–∞—á–µ —É–¥–∞—Ä–∏—Ç –ø–æ –æ—Ä–±–∏—Ç–µ.`,
      choices:[
        { label:"–í–∑—è—Ç—å —Å—Ä–æ—á–Ω–æ –Ω–∞ —Å–µ–±—è", dp:10, ds:15 },
        { label:"–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—Ñ–∏—Ü–µ—Ä–∞–º —Å–≤—è–∑–∏ —Å —á—ë—Ç–∫–∏–º–∏ —Ä–∞–º–∫–∞–º–∏", dp:5, ds:0 },
        { label:"–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å ‚Äî '–Ω–µ –ø–æ –ø–ª–∞–Ω—É'", fatal:true, fatalReason:"–¢—ã –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å–∏–≥–Ω–∞–ª.\n–ö–ª–∏–µ–Ω—Ç —Å–Ω–æ—Å–∏—Ç —á–∞—Å—Ç—å –º–∏—Å—Å–∏–π —Å –æ—Ä–±–∏—Ç—ã.\n–ó–∞–ø—É—Å–∫ –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç—Å—è." }
      ]
    },

    R2: {
      id:"R2",
      title:"R2. –ö–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥–∏—Å—Ç—ã —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π",
      text:
`–ù–∞ —Å—Ç—ã–∫–æ–≤–∫–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è '–º–∞–ª–µ–Ω—å–∫–∞—è –ø—Ä–æ—Å—å–±–∞': –≤—Å–µ–≥–æ –æ–¥–Ω–∞ —Ñ–∏—á–∞.
–ù–æ —É –Ω–µ—ë —Ç–µ–Ω—å ‚Äî –µ—â—ë –¥–µ—Å—è—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –≤ –≥—Ä—É–∑–æ–≤–æ–º –æ—Ç—Å–µ–∫–µ.`,
      choices:[
        { label:"–û—Ç–∫–∞–∑–∞—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã", dp:0, ds:-5 },
        { label:"–°–æ–≥–ª–∞—Å–∏—Ç—å—Å—è, –Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –æ–±—ä—ë–º –ø–∏—Å—å–º–µ–Ω–Ω–æ", dp:5, ds:10 },
        { label:"–°–æ–≥–ª–∞—Å–∏—Ç—å—Å—è –±–µ–∑ —Ñ–∏–∫—Å–∞—Ü–∏–∏ ‚Äî '–ø–æ—Ç–æ–º —Ä–∞–∑–±–µ—Ä—ë–º—Å—è'", dp:10, ds:15, setFlag:{fuzzy_requirements:true} }
      ]
    },

    R3: {
      id:"R3",
      title:"R3. –¢—É–º–∞–Ω–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏",
      text:
`–î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É.
–ö–∞–∂–¥–∞—è –º–µ—Ç—Ä–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥—Ä—É–≥—É—é –í—Å–µ–ª–µ–Ω–Ω—É—é. –†–µ—à–µ–Ω–∏–µ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω—É–∂–Ω–æ —Å–µ–π—á–∞—Å.`,
      choices:[
        { label:"–ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–∫—Ç–æ–≤–∫—É", dp:10, ds:0 },
        { label:"–í—ã–±—Ä–∞—Ç—å '—É–¥–æ–±–Ω—ã–µ' —Ü–∏—Ñ—Ä—ã —Ä–∞–¥–∏ —Ä–µ—à–µ–Ω–∏—è", dp:10, ds:10, setFlag:{audit_risk:true} },
        { label:"–û—Ç–ª–æ–∂–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ –¥–æ –∏–¥–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö", dp:-5, ds:5 }
      ]
    },

    R4: {
      id:"R4",
      title:"R4. –ö–æ–Ω—Ñ–ª–∏–∫—Ç –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤ –æ—Ç—Å–µ–∫–æ–≤",
      text:
`–ö–æ–º–∞–Ω–¥–∏—Ä—ã —Å–ø–æ—Ä—è—Ç: —á–µ–π –æ—Ç—Å–µ–∫ –≤–∞–∂–Ω–µ–µ –¥–ª—è –ø—Ä—ã–∂–∫–∞.
–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Ä–∞–∑–æ–≥—Ä–µ–≤–∞–µ—Ç —Å—Ç—Ä–µ—Å—Å –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º —Ä–µ–∞–∫—Ç–æ—Ä ‚Äî —Ç–æ–ø–ª–∏–≤–æ.`,
      choices:[
        { label:"–°–æ–∑–≤–∞—Ç—å –º–∏–Ω–∏-—Å–æ–≤–µ—Ç –∏ —Ä–∞–∑–≤–µ—Å—Ç–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å", dp:5, ds:5 },
        { label:"–ü—Ä–æ–¥–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ–º —Ä–æ–ª–∏", dp:5, ds:15 },
        {
          label:"–°–¥–µ–ª–∞—Ç—å –≤–∏–¥, —á—Ç–æ –ø—Ä–æ–±–ª–µ–º—ã –Ω–µ—Ç",
          prob: {
            p: 0.25,
            success: { dp:0, ds:10, next:null },
            fail: { fatal:true, fatalReason:"–¢—ã –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª –∫–æ–Ω—Ñ–ª–∏–∫—Ç.\n–û—Ç—Å–µ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å–∞–±–æ—Ç–∏—Ä—É–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É.\n–ú–∏—Å—Å–∏—è —Ä–∞–∑–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º." }
          }
        }
      ]
    },

    R5: {
      id:"R5",
      title:"R5. –ü–æ—Ç–µ—Ä—è –∫–ª—é—á–µ–≤–æ–≥–æ –∏–Ω–∂–µ–Ω–µ—Ä–∞",
      text:
`–ö–ª—é—á–µ–≤–æ–π –∏–Ω–∂–µ–Ω–µ—Ä —É—Ö–æ–¥–∏—Ç –Ω–∞ –¥—Ä—É–≥—É—é –º–∏—Å—Å–∏—é: '—Å–ø–∞—Å–∞—Ç—å –ì–∞–ª–∞–∫—Ç–∏–∫—É'.
–ù—É–∂–Ω–æ –ª–∏–±–æ –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –ø–ª–∞–Ω, –ª–∏–±–æ —Å–ª–æ–º–∞—Ç—å –ª—é–¥–µ–π.`,
      choices:[
        { label:"–ü–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –ø–ª–∞–Ω –∏ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –æ–±—ä—ë–º", dp:5, ds:10 },
        { label:"–î–∞–≤–∏—Ç—å —Å—Ä–æ–∫–∞–º–∏ –∏ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞–º–∏", dp:10, ds:20 },
        { label:"–ó–∞–º–æ—Ä–æ–∑–∏—Ç—å —á–∞—Å—Ç—å –º–∏—Å—Å–∏–∏ —Ä–∞–¥–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏", dp:-5, ds:-5 }
      ]
    },

    R6: {
      id:"R6",
      title:"R6. –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å–æ—é–∑–Ω–∏–∫",
      text:
`–û—Ñ–∏—Ü–µ—Ä –∏–∑ —Å–æ—Å–µ–¥–Ω–µ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–æ–º–æ—â—å: —Ä–µ—Å—É—Ä—Å—ã –∏ –∫–∞–Ω–∞–ª –∫ –°–æ–≤–µ—Ç—É.
–ù–æ –∑–∞ –ø–æ–º–æ—â—å –≤—Å–µ–≥–¥–∞ –ø–ª–∞—Ç—è—Ç –ø–æ–ª–∏—Ç–∏–∫–æ–π.`,
      choices:[
        { label:"–ü—Ä–∏–Ω—è—Ç—å –ø–æ–º–æ—â—å –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏", dp:10, ds:5 },
        { label:"–û—Ç–∫–∞–∑–∞—Ç—å—Å—è: –¥–µ—Ä–∂–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å", dp:0, ds:0 },
        { label:"–ü–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å —Å–æ—é–∑–Ω–∏–∫–∞ –∏ —Ç—Ä–µ–±–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ", dp:10, ds:10 }
      ]
    },

    R7: {
      id:"R7",
      title:"R7. –ü–æ–ª–æ–º–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏",
      text:
`–ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–∏ –¥–∞—é—Ç –¥—Ä–µ–π—Ñ.
–ú–æ–∂–Ω–æ –ø–æ—á–∏–Ω–∏—Ç—å —Ç—â–∞—Ç–µ–ª—å–Ω–æ –∏–ª–∏ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –±—ã—Å—Ç—Ä—ã–π –∫–æ—Å—Ç—ã–ª—å.`,
      choices:[
        { label:"–ü–æ—á–∏–Ω–∏—Ç—å —Ç—â–∞—Ç–µ–ª—å–Ω–æ –∏ —É–±—Ä–∞—Ç—å —Ä–∏—Å–∫", dp:5, ds:-5 },
        { label:"–°–¥–µ–ª–∞—Ç—å –±—ã—Å—Ç—Ä—ã–π –∫–æ—Å—Ç—ã–ª—å –∏ –ª–µ—Ç–µ—Ç—å –¥–∞–ª—å—à–µ", dp:10, ds:10 }
      ]
    },

    R8: {
      id:"R8",
      title:"R8. –í–Ω–µ—à–Ω–∏–π –∞—É–¥–∏—Ç —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏",
      text:
`–ü—Ä–∏—à—ë–ª –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞—É–¥–∏—Ç: —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –ø—Ä–∞–≤–∏–ª–∞–º –∏ –æ–±–µ—â–∞–Ω–∏—è–º.
–ï—Å–ª–∏ —Ç—ã –≥–¥–µ-—Ç–æ '–∑–∞–Ω–∏–∂–∞–ª' —Å–ª–æ–∂–Ω–æ—Å—Ç—å ‚Äî —ç—Ç–æ –≤—Å–ø–ª—ã–≤—ë—Ç.`,
      choices:[
        { label:"–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∏ —á–µ—Å—Ç–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å", dp:10, ds:5, setFlag:{audit_risk:false} },
        {
          label:"–ò–º–ø—Ä–æ–≤–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –Ω–∞–¥–µ—è—Ç—å—Å—è –Ω–∞ —É–¥–∞—á—É",
          prob: {
            p: 0.2,
            success: { dp:10, ds:0, next:null },
            fail: { fatal:true, fatalReason:"–ê—É–¥–∏—Ç –≤—Å–∫—Ä—ã–ª —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è.\n–°–æ–≤–µ—Ç –∑–∞–º–æ—Ä–æ–∑–∏–ª –º–∏—Å—Å–∏—é –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π.\n–ö–æ—Ä–∞–±–ª—å –Ω–µ –ª–µ—Ç–∏—Ç." }
          }
        },
        {
          label:"–°–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ –∏ —É–π—Ç–∏ –æ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤",
          prob: {
            p: 0.15,
            success: { dp:0, ds:20, next:null },
            fail: { fatal:true, fatalReason:"–ü–æ–ø—ã—Ç–∫–∞ —Å–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ –∞—É–¥–∏—Ç–∞.\n–î–æ–≤–µ—Ä–∏–µ –∫ –∫–∞–ø–∏—Ç–∞–Ω—É –ø–æ—Ç–µ—Ä—è–Ω–æ.\n–ú–∏—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞." }
          }
        }
      ]
    }
  };

  // ---------------------------
  // Map layout (–ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞)
  // ---------------------------
  const SVG_NS = "http://www.w3.org/2000/svg";
  const el = (name, attrs = {}, text = null) => {
    const n = document.createElementNS(SVG_NS, name);
    for (const [k,v] of Object.entries(attrs)) n.setAttribute(k, String(v));
    if (text != null) n.textContent = text;
    return n;
  };
  const clear = (node) => { while(node.firstChild) node.removeChild(node.firstChild); };

  // fixed positions (feel like "sector columns")
  const NODE_POS = {
    E1:  {x:120, y:360},
    E2:  {x:230, y:260},
    E3:  {x:330, y:450},
    E4:  {x:440, y:320},
    E5A: {x:540, y:240},
    E6A: {x:610, y:420},
    E5B: {x:560, y:470},
    E6B: {x:650, y:300},
    E7:  {x:720, y:360},
    E8:  {x:820, y:260},
    E9:  {x:900, y:430},
    E10: {x:1020,y:340},
    E11: {x:1100,y:300},

    // random events: near mid/right
    R1:  {x:520, y:170},
    R2:  {x:680, y:520},
    R3:  {x:820, y:360},
    R4:  {x:740, y:200},
    R5:  {x:900, y:540},
    R6:  {x:610, y:150},
    R7:  {x:980, y:230},
    R8:  {x:1010,y:520},

    WIN:  {x:1160,y:270},
    LOSE: {x:1160,y:390}
  };

  const MAIN_CHAIN = ["E1","E2","E3","E4","E7","E8","E9","E10","E11"];

  // route line
  function drawRoute(){
    clear(ui.routeLayer);
    // soft polyline through main chain
    const pts = MAIN_CHAIN.map(id => NODE_POS[id]).filter(Boolean);
    const d = pts.map((p,i)=> (i===0?`M ${p.x} ${p.y}`:`L ${p.x} ${p.y}`)).join(" ");
    ui.routeLayer.appendChild(el("path", {
      d,
      fill:"none",
      stroke:"url(#routeGrad)",
      "stroke-width":"3",
      "stroke-linecap":"round",
      opacity:"0.85"
    }));
  }

  function beaconDiamond(x,y, color, size=12, glow="glowA"){
    const g = el("g", { transform:`translate(${x} ${y})`, filter:`url(#${glow})` });
    g.appendChild(el("path", {
      d: `M 0 ${-size} L ${size} 0 L 0 ${size} L ${-size} 0 Z`,
      fill: color,
      stroke: "rgba(0,0,0,.35)",
      "stroke-width":"1"
    }));
    return g;
  }

  function drawNodes(){
    clear(ui.nodesLayer);

    // draw all E nodes as passive
    for (const [id,p] of Object.entries(NODE_POS)){
      if (!id.startsWith("E")) continue;
      const visited = state.visited.has(id);
      const isCurrent = (state.currentNode === id);
      const r = isCurrent ? 7.5 : (visited ? 6.5 : 5.5);

      const c = el("circle", {
        cx:p.x, cy:p.y, r,
        fill: visited ? "rgba(220,235,255,.45)" : "rgba(220,235,255,.20)",
        stroke: isCurrent ? "rgba(76,201,240,.90)" : "rgba(0,0,0,.35)",
        "stroke-width": isCurrent ? "2" : "1",
        filter: isCurrent ? "url(#glowA)" : "none",
        class:"nodePassive"
      });
      ui.nodesLayer.appendChild(c);

      // tiny label
      ui.nodesLayer.appendChild(el("text",{
        x:p.x + 10, y:p.y + 4,
        fill:"rgba(231,240,255,.45)",
        "font-size":"10",
        "font-family":"ui-monospace, Menlo, Consolas, monospace",
        class:"nodePassive"
      }, id));
    }
  }

  function drawFinish(){
    clear(ui.finishLayer);
    // finish indicator is ALWAYS far right (progress 100)
    const p = {x:1180, y:300};
    const g = beaconDiamond(p.x, p.y, "rgba(124,255,124,.95)", 15, "glowB");
    g.classList.add("nodePassive");
    ui.finishLayer.appendChild(g);
    ui.finishLayer.appendChild(el("text",{
      x:p.x-40, y:p.y-22,
      fill:"rgba(231,240,255,.80)",
      "font-size":"12",
      "font-family":"ui-monospace, Menlo, Consolas, monospace",
      class:"nodePassive"
    }, "100"));
  }

  function drawShip(){
    clear(ui.shipLayer);
    // ship pinned to current node if known, otherwise based on progress along main chain
    const pn = NODE_POS[state.currentNode];
    const t = clamp(state.progress / 100, 0, 1);

    // approximate interpolation along main chain
    const chainPts = MAIN_CHAIN.map(id => NODE_POS[id]);
    const segCount = chainPts.length - 1;
    const segFloat = t * segCount;
    const i = Math.min(segCount - 1, Math.max(0, Math.floor(segFloat)));
    const lt = segFloat - i;
    const a = chainPts[i], b = chainPts[i+1];
    const interp = { x: a.x + (b.x-a.x)*lt, y: a.y + (b.y-a.y)*lt };

    const pos = pn || interp;

    const g = el("g", { transform:`translate(${pos.x} ${pos.y})`, filter:"url(#glowB)" });
    g.appendChild(el("circle",{
      cx:0, cy:0, r:11,
      fill:"rgba(76,201,240,.18)",
      stroke:"rgba(76,201,240,.70)",
      "stroke-width":"2"
    }));
    g.appendChild(el("path",{
      d:"M -2 -8 L 12 0 L -2 8 Z",
      fill:"rgba(76,201,240,.95)",
      stroke:"rgba(0,0,0,.35)",
      "stroke-width":"1"
    }));
    g.appendChild(el("text",{
      x:16, y:-10,
      fill:"rgba(231,240,255,.85)",
      "font-size":"12",
      "font-family":"ui-monospace, Menlo, Consolas, monospace"
    }, `${state.progress}%`));
    ui.shipLayer.appendChild(g);
  }

  // ---------------------------
  // Choices rendering (ONLY one set; no duplicates on desktop)
  // ---------------------------
  function renderChoicesList(choices, isEnd){
    ui.choicesList.innerHTML = "";
    // used only on small screens via CSS
    for (const c of choices){
      const btn = document.createElement("button");
      btn.textContent = c.label;
      btn.addEventListener("click", () => choose(c));
      if (isEnd) btn.style.borderColor = "rgba(124,255,124,.45)";
      ui.choicesList.appendChild(btn);
    }
  }

  function renderChoiceBeacons(choices, { isEnd=false } = {}){
    clear(ui.choicesLayer);

    if (isEnd){
      // place restart beacon near left-bottom area, clickable
      const p = {x:220, y:610};
      const g = beaconDiamond(p.x, p.y, "rgba(124,255,124,.95)", 16, "glowB");
      g.classList.add("clickable","noSelect");
      g.setAttribute("tabindex","0");
      g.setAttribute("role","button");
      g.setAttribute("aria-label", choices[0].label);
      g.appendChild(el("title", {}, choices[0].label));
      g.addEventListener("click", () => choose(choices[0]));
      g.addEventListener("keydown", (e)=>{ if(e.key==="Enter") choose(choices[0]); });
      ui.choicesLayer.appendChild(g);
      ui.choicesLayer.appendChild(el("text",{
        x:p.x+22, y:p.y+5,
        fill:"rgba(231,240,255,.90)",
        "font-size":"12",
        "font-family":"ui-monospace, Menlo, Consolas, monospace"
      }, "NEW CYCLE"));
      return;
    }

    // show choice beacons around current position (NOT on finish, NOT clickable on passive nodes)
    const base = NODE_POS[state.currentNode] || {x:420, y:360};
    const ring = [
      {dx: 140, dy:-90},
      {dx: 170, dy:  0},
      {dx: 140, dy: 90},
      {dx:  90, dy: 140},
      {dx:  90, dy:-140},
    ];

    choices.forEach((c, idx) => {
      const pos = { x: base.x + ring[idx % ring.length].dx, y: base.y + ring[idx % ring.length].dy };

      const g = beaconDiamond(pos.x, pos.y, "rgba(76,201,240,.95)", 14, "glowB");
      g.classList.add("clickable","noSelect");
      g.setAttribute("tabindex","0");
      g.setAttribute("role","button");
      g.setAttribute("aria-label", c.label);
      g.appendChild(el("title", {}, c.label));

      g.addEventListener("click", () => choose(c));
      g.addEventListener("keydown", (e)=>{ if(e.key==="Enter") choose(c); });

      // short label: show next node id if exists, else "?"
      const next = resolveNext(c.next);
      const short = (typeof next === "string") ? next : "?";
      ui.choicesLayer.appendChild(g);
      ui.choicesLayer.appendChild(el("text",{
        x: pos.x + 18, y: pos.y + 4,
        fill:"rgba(231,240,255,.78)",
        "font-size":"11",
        "font-family":"ui-monospace, Menlo, Consolas, monospace"
      }, short));
    });
  }

  // ---------------------------
  // Render node
  // ---------------------------
  function renderNode(node){
    if (!node) return;

    const isRandom = node.id && node.id.startsWith("R");
    if (isRandom) {
      setTag("warn", "–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ");
    } else {
      setTag("", node.sector || "–°–µ–∫—Ç–æ—Ä");
    }

    ui.sceneTitle.textContent = node.title;
    ui.sceneText.textContent = node.text;

    let choices = node.choices || [];

    // random nodes: after selecting, return to pendingReturn unless explicit next
    if (isRandom) {
      choices = (node.choices || []).map(c => ({
        ...c,
        _action: () => {
          const pending = state.pendingReturn;
          state.pendingReturn = null;

          if (c.fatal) { fatal(c.fatalReason || "–ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞."); return; }
          if (c.setFlag) for (const [k,v] of Object.entries(c.setFlag)) state.flags[k] = v;

          // probabilistic choice inside random event option (if any)
          if (c.prob){
            if (chance(c.prob.p)){
              const s = c.prob.success;
              if (s.setFlag) for (const [k,v] of Object.entries(s.setFlag)) state.flags[k] = v;
              if (s.fatal) { fatal(s.fatalReason || "–ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞."); return; }
              applyDelta(s.dp || 0, s.ds || 0);
              if (s.next) { goTo(resolveNext(s.next)); return; }
            } else {
              const f = c.prob.fail;
              if (f.setFlag) for (const [k,v] of Object.entries(f.setFlag)) state.flags[k] = v;
              if (f.fatal) { fatal(f.fatalReason || "–ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞."); return; }
              applyDelta(f.dp || 0, f.ds || 0);
              if (f.next) { goTo(resolveNext(f.next)); return; }
            }
          } else {
            applyDelta(c.dp || 0, c.ds || 0);
          }

          const nextExplicit = resolveNext(c.next);
          if (nextExplicit) { goTo(nextExplicit); return; }
          goTo(pending || "E11");
        }
      }));
    }

    // E11 dynamic choices
    if (node.id === "E11") {
      if (state.progress >= 85 && state.stress < 80) setTag("good", "–§–∏–Ω–∞–ª: –ü—Ä—ã–∂–æ–∫");
      else if (state.stress >= 80) setTag("bad", "–§–∏–Ω–∞–ª: –ù–∞ –ø—Ä–µ–¥–µ–ª–µ");
      else setTag("warn", "–§–∏–Ω–∞–ª: –†–∏—Å–∫");

      const c1 = {
        label:"–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—ã –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä—ã–∂–æ–∫",
        _action: () => {
          applyDelta(10, 10);
          if (endIfNeeded()) return;

          state.pendingReturn = "E11";
          state.currentNode = "R7";
          state.visited.add("R7");
          renderNode(randomEvents["R7"]);
          updateBars();
          drawAll();
        }
      };

      const c2 = {
        label:"–°–¥–µ–ª–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∫–∞–ª–∏–±—Ä–æ–≤–∫—É –ø–µ—Ä–µ–¥ –ø—Ä—ã–∂–∫–æ–º",
        _action: () => {
          applyDelta(5, -5);
          if (endIfNeeded()) return;

          state.pendingReturn = "E11";
          let pick = Object.keys(randomEvents)[rnd(0, Object.keys(randomEvents).length - 1)];
          if (state.flags.audit_risk && chance(0.5)) pick = "R8";

          state.currentNode = pick;
          state.visited.add(pick);
          renderNode(randomEvents[pick]);
          updateBars();
          drawAll();
        }
      };

      choices = [c1, c2];
    }

    // show beacons (main interaction)
    renderChoiceBeacons(choices, { isEnd:false });
    renderChoicesList(choices, false);

    drawAll();
  }

  function drawAll(){
    drawRoute();
    drawNodes();
    drawFinish();
    drawShip();
  }

  function resetGame(){
    state.progress = 0;
    state.stress = 20;
    state.cycle += 1;
    state.flags = { asteroid_possible:false, fuzzy_requirements:false, audit_risk:false };
    state.stepsSinceRandom = 0;
    state.pendingReturn = null;
    state.currentNode = "E1";
    state.visited = new Set(["E1"]);

    updateBars();
    renderNode(nodes["E1"]);
  }

  // ---------------------------
  // Boot
  // ---------------------------
  updateBars();
  drawAll();
  renderNode(nodes[state.currentNode]);

})();
</script>
</body>
</html>
