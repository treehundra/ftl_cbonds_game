<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cbonds: –ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –∫–≤–∏–∑</title>

  <style>
    :root{
      --panel: rgba(8,14,28,.72);
      --panel2: rgba(10,18,34,.86);
      --stroke: rgba(120,160,255,.22);
      --text: #e7f0ff;
      --muted:#a6b7d8;

      --accent:#4cc9f0;
      --good:#7CFF7C;
      --bad:#ff4d6d;
      --warn:#ffd166;

      --shadow: 0 24px 80px rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1000px 700px at 30% 20%, rgba(76,201,240,.16), transparent 62%),
        radial-gradient(900px 650px at 70% 40%, rgba(124,255,124,.10), transparent 65%),
        radial-gradient(1100px 800px at 50% 120%, rgba(255,77,109,.09), transparent 70%),
        linear-gradient(180deg, #07132a, #030611);
      overflow:hidden;
      color:var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* Fullscreen SVG container */
    #mapSvg{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      display:block;
      pointer-events:auto;
      touch-action:none;
    }

    /* HUD */
    .hudTop{
      position:fixed;
      top:18px;
      left:18px;
      right:18px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      pointer-events:none;
      z-index: 20;
    }

    .brand, .stats{
      pointer-events:auto;
      border:1px solid var(--stroke);
      background: var(--panel);
      backdrop-filter: blur(10px);
      border-radius:16px;
      box-shadow: var(--shadow);
    }

    .brand{
      max-width: 680px;
      padding:14px 16px;
    }
    .brand h1{
      margin:0 0 6px 0;
      font-size:16px;
      color: var(--accent);
      letter-spacing:.3px;
    }
    .brand p{
      margin:0;
      font-size:12px;
      color: var(--muted);
      line-height:1.5;
    }

    .stats{
      min-width: 280px;
      padding:14px 16px;
    }
    .statRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      color: var(--muted);
      margin-bottom:8px;
    }
    .bar{
      height:10px;
      border-radius:999px;
      border:1px solid rgba(120,160,255,.18);
      background: rgba(2,6,16,.55);
      overflow:hidden;
      margin-bottom:14px;
    }
    .fill{ height:100%; width:0%; transition: width .25s ease; }
    .fill.progress{ background: linear-gradient(90deg, rgba(124,255,124,.85), rgba(76,201,240,.75)); }
    .fill.stress{ background: linear-gradient(90deg, rgba(255,77,109,.85), rgba(255,209,102,.55)); }

    /* Modal */
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(4px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index: 50;
    }
    .modal{
      width: min(760px, 100%);
      border:1px solid var(--stroke);
      background: var(--panel2);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:16px 16px 14px 16px;
    }
    .modalTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:11px;
      color: var(--muted);
      text-transform:uppercase;
      letter-spacing:.35px;
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 12px rgba(76,201,240,.55);
    }
    .dot.good{ background: var(--good); box-shadow: 0 0 12px rgba(124,255,124,.45); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 12px rgba(255,209,102,.35); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 12px rgba(255,77,109,.40); }

    .meta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size:12px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(120,160,255,.18);
      background: rgba(2,6,16,.40);
    }
    .pill b{ color: var(--text); }

    .qTitle{ margin:0 0 8px 0; font-size:15px; line-height:1.25; }
    .qText{ margin:0; font-size:13px; line-height:1.55; white-space:pre-wrap; color: rgba(231,240,255,.95); }

    .choices{
      margin-top:12px;
      display:grid;
      gap:10px;
    }
    .choices button{
      width:100%;
      text-align:left;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(120,160,255,.18);
      background: rgba(2,6,16,.48);
      color: var(--text);
      cursor:pointer;
      font: inherit;
      transition: transform .06s ease, border-color .12s ease, background .12s ease;
    }
    .choices button:hover{
      border-color: rgba(76,201,240,.35);
      background: rgba(6,14,30,.55);
    }
    .choices button:active{ transform: translateY(1px); }

    .modalHint{
      margin-top:10px;
      font-size:12px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    @media (max-width: 780px){
      .hudTop{ flex-direction:column; align-items:stretch; }
      .stats{ min-width: unset; }
    }
  </style>
</head>

<body>
  <svg id="mapSvg" viewBox="0 0 1200 700" preserveAspectRatio="xMidYMid meet" role="img" aria-label="–ö–∞—Ä—Ç–∞ —Å–µ–∫—Ç–æ—Ä–æ–≤">
    <defs>
      <filter id="glowA" x="-60%" y="-60%" width="220%" height="220%">
        <feGaussianBlur stdDeviation="3" result="blur"/>
        <feMerge>
          <feMergeNode in="blur"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
      <filter id="glowB" x="-80%" y="-80%" width="260%" height="260%">
        <feGaussianBlur stdDeviation="7" result="blur"/>
        <feMerge>
          <feMergeNode in="blur"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>

      <style>
        .pulse { animation: pulse 1.35s ease-in-out infinite; transform-origin: center; }
        @keyframes pulse{
          0%,100%{ opacity: .75; transform: scale(1); }
          50%{ opacity: 1; transform: scale(1.08); }
        }
      </style>
    </defs>

    <g id="world">
      <!-- IMPORTANT: no slashes in filenames -->
      <image id="bgImg" href="map.png" x="0" y="0" width="1200" height="700"
             preserveAspectRatio="xMidYMid slice" opacity="0.92" pointer-events="none"></image>

      <rect x="0" y="0" width="1200" height="700" fill="rgba(0,0,0,.22)" pointer-events="none"></rect>

      <!-- Cbonds watermark (no slashes) -->
      <image id="logoImg" href="cbonds.png" x="760" y="590" width="420" height="90"
             opacity="0.18" pointer-events="none"></image>

      <g id="beaconsLayer"></g>
      <g id="shipLayer"></g>
      <g id="exitLayer"></g>
    </g>
  </svg>

  <div class="hudTop">
    <div class="brand">
      <h1>Cbonds: –ü–æ–ª—ë—Ç –∫ —Ü–µ–Ω—Ç—Ä—É –ì–∞–ª–∞–∫—Ç–∏–∫–∏</h1>
      <p>–ö–ª–∏–∫–∞–π—Ç–µ –ø–æ –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω—ã–º —Å–µ–∫—Ç–æ—Ä–∞–º: –∫–æ—Ä–∞–±–ª—å –ø–µ—Ä–µ–ª–µ—Ç–∏—Ç ‚Üí –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ ‚Üí –≤—ã –≤—ã–±–∏—Ä–∞–µ—Ç–µ –æ—Ç–≤–µ—Ç ‚Üí –º–µ–Ω—è—é—Ç—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Å—Ç—Ä–µ—Å—Å ‚Üí –ø–æ—è–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞.</p>
      <p style="margin-top:6px;color:rgba(166,183,216,.9)">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π: –∫–æ–ª–µ—Å–æ/—Ç—Ä–µ–∫–ø–∞–¥ ‚Äî –∑—É–º, –∑–∞–∂–∞—Ç–∞—è –õ–ö–ú/—Ç–∞—á ‚Äî –ø–∞–Ω–æ—Ä–∞–º–∞.</p>
    </div>

    <div class="stats">
      <div class="statRow"><span>üöÄ –ü—Ä–æ–≥—Ä–µ—Å—Å</span><span id="progressNum">0 / 100</span></div>
      <div class="bar"><div class="fill progress" id="progressFill"></div></div>

      <div class="statRow"><span>‚ö†Ô∏è –°—Ç—Ä–µ—Å—Å</span><span id="stressNum">20 / 100</span></div>
      <div class="bar" style="margin-bottom:0;"><div class="fill stress" id="stressFill"></div></div>
    </div>
  </div>

  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-label="–°–æ–±—ã—Ç–∏–µ">
    <div class="modal">
      <div class="modalTop">
        <div class="tag"><span id="tagDot" class="dot"></span><span id="tagText">–°–µ–∫—Ç–æ—Ä</span></div>
        <div class="meta">
          <span class="pill">–¶–∏–∫–ª: <b id="cycle">1</b></span>
          <span class="pill">–ü—Ä–∏–ª–µ—Ç–µ–ª–∏</span>
        </div>
      </div>

      <h2 class="qTitle" id="qTitle">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</h2>
      <p class="qText" id="qText"></p>

      <div class="choices" id="qChoices"></div>

      <div class="modalHint">
        <span>–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –æ–∫–Ω–æ –∑–∞–∫—Ä–æ–µ—Ç—Å—è, –∏ –ø–æ—è–≤—è—Ç—Å—è –Ω–æ–≤—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞.</span>
        <span>–§–∏–Ω–∏—à ‚Äî –∫—Ä–∞–π–Ω—è—è –ø—Ä–∞–≤–∞—è —Ç–æ—á–∫–∞ (100).</span>
      </div>
    </div>
  </div>

<script>
(() => {
  // =====================
  // STATE
  // =====================
  const state = {
    progress: 0,
    stress: 20,
    cycle: 1,
    flags: {
      asteroid_possible: false,
      fuzzy_requirements: false,
      audit_risk: false
    },
    stepsSinceRandom: 0,
    pendingReturn: null,

    currentNode: "E1",
    visited: new Set(["E1"]),
    available: new Set(["E1"]),
    isTraveling: false
  };

  // =====================
  // UI refs
  // =====================
  const ui = {
    svg: document.getElementById("mapSvg"),
    beaconsLayer: document.getElementById("beaconsLayer"),
    shipLayer: document.getElementById("shipLayer"),
    exitLayer: document.getElementById("exitLayer"),

    progressFill: document.getElementById("progressFill"),
    stressFill: document.getElementById("stressFill"),
    progressNum: document.getElementById("progressNum"),
    stressNum: document.getElementById("stressNum"),

    modalBack: document.getElementById("modalBack"),
    tagDot: document.getElementById("tagDot"),
    tagText: document.getElementById("tagText"),
    cycle: document.getElementById("cycle"),
    qTitle: document.getElementById("qTitle"),
    qText: document.getElementById("qText"),
    qChoices: document.getElementById("qChoices"),
  };

  // =====================
  // Helpers
  // =====================
  const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
  const rnd = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
  const chance = (p) => Math.random() < p;

  function updateBars(){
    ui.progressFill.style.width = state.progress + "%";
    ui.stressFill.style.width = state.stress + "%";
    ui.progressNum.textContent = `${state.progress} / 100`;
    ui.stressNum.textContent = `${state.stress} / 100`;
    ui.cycle.textContent = String(state.cycle);
  }

  function setTag(kind, text){
    ui.tagText.textContent = text;
    ui.tagDot.className = "dot" + (kind ? (" " + kind) : "");
  }

  function applyDelta(dp=0, ds=0){
    state.progress = clamp(state.progress + dp, 0, 100);
    state.stress   = clamp(state.stress + ds, 0, 100);
    updateBars();
  }

  // =====================
  // Content (–æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ –±—ã–ª–æ ‚Äî —Ç–≤–æ–∏ —Ç–µ–∫—Å—Ç—ã)
  // =====================
  const nodes = {
    E1: {
      id:"E1", sector:"–û—Ä–±–∏—Ç–∞ –ö–ª–∏–µ–Ω—Ç–æ–≤",
      title:"–ü—Ä–∏—ë–º —Å–∏–≥–Ω–∞–ª–∞ —Å –ø–ª–∞–Ω–µ—Ç—ã –ö–ª–∏–µ–Ω—Ç–æ–≤",
      text:`–ö–∞–ø–∏—Ç–∞–Ω –ø–æ–ª—É—á–∞–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∏–≥–Ω–∞–ª.
–ö–ª–∏–µ–Ω—Ç—ã —Ç—Ä–µ–±—É—é—Ç –∏–∑–º–µ–Ω–∏—Ç—å –∫—É—Ä—Å. –í —ç—Ñ–∏—Ä–µ ‚Äî —à—É–º: —Å—Ä–æ—á–Ω–æ—Å—Ç—å, —ç–º–æ—Ü–∏–∏ –∏ —Ä–∞—Å–ø–ª—ã–≤—á–∞—Ç—ã–µ –æ–±–µ—â–∞–Ω–∏—è.`,
      choices:[
        { label:"–†–∞–∑–æ–±—Ä–∞—Ç—å —Å–∏–≥–Ω–∞–ª, —Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏", dp:10, ds:5, next:"E2" },
        { label:"–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ–æ–±–µ—â–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ —Å—Ä–æ–∫–∏", dp:15, ds:15, next:"E2" },
        { label:"–û—Ç–ª–æ–∂–∏—Ç—å —Å–∏–≥–Ω–∞–ª –≤ –∞—Ä—Ö–∏–≤ –ì–∞–ª–∞–∫—Ç–∏–∫–∏", dp:-5, ds:-5, setFlag:{asteroid_possible:true}, next:"E2" }
      ]
    },
    E2: {
      id:"E2", sector:"–°–æ–≤–µ—Ç –ú–µ–∂–∑–≤—ë–∑–¥–Ω–æ–π –°–≤—è–∑–∏",
      title:"–°–æ–≤–µ—Ç –ú–µ–∂–∑–≤—ë–∑–¥–Ω–æ–π –°–≤—è–∑–∏",
      text:`–°–æ–±—Ä–∞–ª–∏—Å—å –ì–ª–∞–≤–Ω–æ–∫–æ–º–∞–Ω–¥—É—é—â–∏–π, –û—Å–Ω–æ–≤–∞—Ç–µ–ª—å –í—Å–µ–ª–µ–Ω–Ω–æ–π –∏ –æ—Ñ–∏—Ü–µ—Ä—ã —Å–≤—è–∑–∏.
–¢–µ–±—è —Å–ª—É—à–∞—é—Ç –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ. –£ —Ç–µ–±—è –æ–¥–∏–Ω —à–∞–Ω—Å –∑–∞–¥–∞—Ç—å —Ç–æ–Ω –º–∏—Å—Å–∏–∏.`,
      choices:[
        { label:"–ó–∞—â–∏—Ç–∏—Ç—å —Ü–µ–Ω–Ω–æ—Å—Ç—å –º–∏—Å—Å–∏–∏ —Ü–∏—Ñ—Ä–∞–º–∏ –∏ —Ñ–∞–∫—Ç–∞–º–∏", dp:15, ds:-5, next:"E3" },
        { label:"–î–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–æ–º –∫–ª–∏–µ–Ω—Ç–∞ –±–µ–∑ –º–µ—Ç—Ä–∏–∫", dp:10, ds:10, next:"E3" },
        { label:"–ü—É–±–ª–∏—á–Ω–æ —Å–ø–æ—Ä–∏—Ç—å —Å –ì–ª–∞–≤–Ω–æ–∫–æ–º–∞–Ω–¥—É—é—â–∏–º", fatal:true, fatalReason:"–ü—É–±–ª–∏—á–Ω—ã–π —Å–ø–æ—Ä.\n–ü–æ—Ç–µ—Ä—è –¥–æ–≤–µ—Ä–∏—è –°–æ–≤–µ—Ç–∞.\n–ú–∏—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –µ—â—ë –¥–æ —Å—Ç–∞—Ä—Ç–∞." }
      ]
    },
    E3: {
      id:"E3", sector:"–ó–≤—ë–∑–¥–Ω–∞—è –∫–∞—Ä—Ç–∞",
      title:"–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–≤—ë–∑–¥–Ω–æ–π –∫–∞—Ä—Ç—ã –º–∏—Å—Å–∏–π",
      text:`–ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π –¥–µ—Å—è—Ç–∫–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏ –∑–∞–ø—Ä–æ—Å–æ–≤.
–ö–∞–∂–¥—ã–π ‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–∫—Å–ø–µ–¥–∏—Ü–∏—è. –ù–æ —Ç–æ–ø–ª–∏–≤–∞ –∏ —ç–∫–∏–ø–∞–∂–µ–π –º–∞–ª–æ.`,
      choices:[
        { label:"–ñ—ë—Å—Ç–∫–æ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ –∏ —Ü–µ–Ω–Ω–æ—Å—Ç–∏", dp:15, ds:-5, next:"E4" },
        { label:"–í–∑—è—Ç—å –≤—Å—ë –≤ —Ä–∞–±–æ—Ç—É ‚Äî —Ä–∞–∑–±–µ—Ä—ë–º—Å—è –ø–æ –¥–æ—Ä–æ–≥–µ", dp:10, ds:20, setFlag:{fuzzy_requirements:true}, next:"E4" },
        { label:"–ü–µ—Ä–µ–¥–∞—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—é –∫–æ–º–∞–Ω–¥–∏—Ä–∞–º –æ—Ç—Å–µ–∫–æ–≤", dp:10, ds:10, next:"E4" }
      ]
    },
    E4: {
      id:"E4", sector:"–í—ã–±–æ—Ä –∫–æ—Ä–∞–±–ª—è",
      title:"–í—ã–±–æ—Ä —Ç–∏–ø–∞ –∫–æ—Ä–∞–±–ª—è",
      text:`–ù—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç:
—Ç—è–∂—ë–ª—ã–π –∫—Ä–µ–π—Å–µ—Ä ‚Äî –¥–∞–ª—å–Ω–∏–π –∏ —Å–ª–æ–∂–Ω—ã–π –ø—É—Ç—å,
–∏–ª–∏ –º–∞–Ω—ë–≤—Ä–µ–Ω–Ω—ã–π —à–∞—Ç—Ç–ª ‚Äî –±—ã—Å—Ç—Ä—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä—ã–∂–∫–∏.`,
      choices:[
        { label:"–í—ã–±—Ä–∞—Ç—å —Ç—è–∂—ë–ª—ã–π –∫—Ä–µ–π—Å–µ—Ä", dp:20, ds:10, next:"E5A" },
        { label:"–í—ã–±—Ä–∞—Ç—å –º–∞–Ω—ë–≤—Ä–µ–Ω–Ω—ã–π —à–∞—Ç—Ç–ª", dp:15, ds:-5, next:"E5B" },
        { label:"–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–∞ –º–∞—Ä—à—Ä—É—Ç–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ", dp:10, ds:25, setFlag:{fuzzy_requirements:true}, next:"E7" }
      ]
    },
    E5A: {
      id:"E5A", sector:"–ö–æ—Ä–ø—É—Å –†–∞–∑–≤–∏—Ç–∏—è",
      title:"–°–æ–≤–µ—Ç –ö–æ—Ä–ø—É—Å–∞ –†–∞–∑–≤–∏—Ç–∏—è",
      text:`–ò–Ω–∂–µ–Ω–µ—Ä—ã —Å–º–æ—Ç—Ä—è—Ç –Ω–∞ —Ç–µ–±—è –±–µ–∑ —ç–º–æ—Ü–∏–π.
–ò–º –Ω—É–∂–Ω—ã —è—Å–Ω–æ—Å—Ç—å, —Ä–∏—Å–∫–∏ –∏ –≥–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ –∫–æ—Ä–∞–±–ª—å –Ω–µ —Ä–∞–∑–≤–∞–ª–∏—Ç—Å—è –Ω–∞ —Å—Ç–∞—Ä—Ç–µ.`,
      choices:[
        { label:"–ü—Ä–∏–Ω–µ—Å—Ç–∏ –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø–ª–∞–Ω, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ —Ä–∏—Å–∫–∏", dp:15, ds:-5, next:"E6A" },
        { label:"–ü—Ä–∏–π—Ç–∏ —Å –∏–¥–µ–µ–π –±–µ–∑ –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏", dp:-10, ds:15, setFlag:{fuzzy_requirements:true}, next:"E6A" },
        { label:"–ü—É–±–ª–∏—á–Ω–æ –æ–±–≤–∏–Ω–∏—Ç—å –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤ –≤ —Ç–æ—Ä–º–æ–∂–µ–Ω–∏–∏", fatal:true, fatalReason:"–ö–æ–Ω—Ñ–ª–∏–∫—Ç.\n–¢–µ–±—è –æ—Ç—Å—Ç—ã–∫–æ–≤–∞–ª–∏ –æ—Ç –∞–Ω–≥–∞—Ä–∞.\n–ú–∏—Å—Å–∏—è —Å–æ—Ä–≤–∞–Ω–∞." }
      ]
    },
    E6A: {
      id:"E6A", sector:"–ê–Ω–≥–∞—Ä",
      title:"–û–∂–∏–¥–∞–Ω–∏–µ —Å–±–æ—Ä–∫–∏ –∫–æ—Ä–∞–±–ª—è",
      text:`–ê–Ω–≥–∞—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω.
–ú–æ–∂–Ω–æ –∂–¥–∞—Ç—å, –º–æ–∂–Ω–æ –¥–∞–≤–∏—Ç—å, –º–æ–∂–Ω–æ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ–±–æ–π—Ç–∏ –æ—á–µ—Ä–µ–¥—å.`,
      choices:[
        { label:"–¢–µ—Ä–ø–µ–ª–∏–≤–æ –∂–¥–∞—Ç—å, —É–ª—É—á—à–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –º–∏—Å—Å–∏–∏", dp:10, ds:-5, next:"E7" },
        { label:"–î–∞–≤–∏—Ç—å –∏ —É—Å–∫–æ—Ä—è—Ç—å —Å–±–æ—Ä–∫—É –ª—é–±–æ–π —Ü–µ–Ω–æ–π", dp:15, ds:15, next:"E7" },
        {
          label:"–ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ–±–æ–π—Ç–∏ –æ—á–µ—Ä–µ–¥—å –≤ –∞–Ω–≥–∞—Ä–µ",
          prob: {
            p: 0.5,
            success: { dp:20, ds:0, next:"E7" },
            fail: { fatal:true, fatalReason:"–°–∫–∞–Ω–¥–∞–ª –≤ –∞–Ω–≥–∞—Ä–µ.\n–ú–∏—Å—Å–∏—è –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∞." }
          }
        }
      ]
    },
    E5B: {
      id:"E5B", sector:"–°–æ–≤–µ—Ç –§–ª–æ—Ç–∞",
      title:"–ü—Ä—è–º–æ–π –≤—ã—Ö–æ–¥ –Ω–∞ –°–æ–≤–µ—Ç –§–ª–æ—Ç–∞",
      text:`–ö–æ–º–∞–Ω–¥–æ–≤–∞–Ω–∏–µ –∂–¥—ë—Ç –∑–∞—â–∏—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∞.`,
      choices:[
        { label:"–ö–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É: —Ü–µ–ª—å, –ø–ª–∞–Ω, —Ä–∏—Å–∫–∏", dp:15, ds:-5, next:"E6B" },
        { label:"–î–∞–≤–∏—Ç—å —Å—Ä–æ–∫–∞–º–∏: '–Ω—É–∂–Ω–æ –≤—á–µ—Ä–∞'", dp:10, ds:15, next:"E6B" },
        { label:"–í—ã–Ω–µ—Å—Ç–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—É–±–ª–∏—á–Ω–æ", fatal:true, fatalReason:"–ö–æ–Ω—Ñ–ª–∏–∫—Ç.\n–ó–∞–ø—É—Å–∫ –æ—Ç–º–µ–Ω—ë–Ω." }
      ]
    },
    E6B: {
      id:"E6B", sector:"–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —à–∞—Ç—Ç–ª–∞",
      title:"–ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫",
      text:`–í—Å—ë –¥–µ—Ä–∂–∏—Ç—Å—è –Ω–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫.
–û–¥–Ω–æ —Ç—É–º–∞–Ω–Ω–æ–µ —Å–ª–æ–≤–æ ‚Äî –∏ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è —Å—Ç–∞–Ω–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π.`,
      choices:[
        { label:"–ß—ë—Ç–∫–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –æ–±—ä—ë–º –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏", dp:15, ds:-5, next:"E7" },
        { label:"–û—Å—Ç–∞–≤–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è —Ä–∞–∑–º—ã—Ç—ã–º–∏", dp:10, ds:15, setFlag:{fuzzy_requirements:true}, next:"E7" },
        { label:"–†–∞—Å—à–∏—Ä–∏—Ç—å –æ–±—ä—ë–º '–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π'", dp:5, ds:20, setFlag:{fuzzy_requirements:true}, next:"E7" }
      ]
    },
    E7: {
      id:"E7", sector:"–†–∞–∑–±–æ—Ä —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏",
      title:"–†–∞–∑–±–æ—Ä –º–∞—Ä—à—Ä—É—Ç–∞",
      text:`–ï—Å–ª–∏ –º–∞—Ä—à—Ä—É—Ç –æ–ø–∏—Å–∞–Ω —Ç—É–º–∞–Ω–Ω–æ ‚Äî –º–∏—Å—Å–∏—é –≤–µ—Ä–Ω—É—Ç –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∫–∞–ª–∏–±—Ä–æ–≤–∫—É.`,
      choices:[
        { label:"–û—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç –¥–æ —è—Å–Ω–æ—Å—Ç–∏", dp:15, ds:-5, setFlag:{fuzzy_requirements:false}, next:"E8" },
        { label:"–û—Å—Ç–∞–≤–∏—Ç—å —Ç—É–º–∞–Ω: '–≥–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'", dp:-5, ds:15, setFlag:{fuzzy_requirements:true}, next:"E8" },
        { label:"–°–∫–∞–∑–∞—Ç—å: '—Ä–∞–∑–±–µ—Ä—ë—Ç–µ—Å—å –ø–æ —Ö–æ–¥—É'", dp:-10, ds:20, setFlag:{fuzzy_requirements:true}, next:"E8" }
      ]
    },
    E8: {
      id:"E8", sector:"–û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏",
      title:"–†–∞—Å—á—ë—Ç —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–∏",
      text:`–ú–∏—Å—Å–∏—è –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å –∑–∞–ø—É—Å–∫–∞.`,
      choices:[
        { label:"–ß–µ—Å—Ç–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —ç—Ç–∞–ø–Ω–æ—Å—Ç—å", dp:15, ds:-5, next:"E9" },
        { label:"–ó–∞–Ω–∏–∂–∞—Ç—å –æ—Ü–µ–Ω–∫–∏, —á—Ç–æ–±—ã –ø—Ä–æ–±–∏—Ç—å—Å—è –≤ –æ—á–µ—Ä–µ–¥—å", dp:20, ds:15, addStressLater:true, next:"E9" },
        { label:"–ü—Ä–æ–ª–µ–∑—Ç—å –≤–Ω–µ –æ—á–µ—Ä–µ–¥–∏ —á–µ—Ä–µ–∑ –¥–∞–≤–ª–µ–Ω–∏–µ", fatal:true, fatalReason:"–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª.\n–ú–∏—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞." }
      ]
    },
    E9: {
      id:"E9", sector:"–ë–æ–ª—å—à–æ–π –°–æ–≤–µ—Ç",
      title:"–ë–æ–ª—å—à–æ–π –°–æ–≤–µ—Ç",
      text:`–ò–¥—É—Ç —Å—Ä–∞–∂–µ–Ω–∏—è –∑–∞ –∫–∞–∂–¥—ã–π —Å–ª–æ—Ç –∑–∞–ø—É—Å–∫–∞.`,
      choices:[
        { label:"–î–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è —Å —Å–æ—é–∑–Ω–∏–∫–∞–º–∏ –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç", dp:20, ds:5, next:"E10" },
        { label:"–ü–æ–π—Ç–∏ –≤ –æ–¥–∏–Ω–æ—á–Ω—ã–π —à—Ç—É—Ä–º –°–æ–≤–µ—Ç–∞", dp:15, ds:15, next:"E10" },
        { label:"–£—Å—Ç—Ä–æ–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∑–∞ —Å–ª–æ—Ç", dp:0, ds:40, next:"E10" }
      ]
    },
    E10: {
      id:"E10", sector:"–û–∫–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏",
      title:"–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏",
      text:`–ï—Å—Ç—å –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–∫–Ω–æ, —á—Ç–æ–±—ã –º–µ–Ω—è—Ç—å –º–∞—Ä—à—Ä—É—Ç.`,
      choices:[
        { label:"–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ –±–µ–∑ —Å—Ä—ã–≤–∞ —Å—Ç–∞—Ä—Ç–∞", dp:10, ds:-5, next:"E11" },
        { label:"–°—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç", dp:10, ds:20, setFlag:{fuzzy_requirements:true}, next:"E11" },
        { label:"–û—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ–ø—Ä–µ–∫–∏ –¥–∞–Ω–Ω—ã–º", dp:-10, ds:20, next:"E11" }
      ]
    },
    E11: {
      id:"E11", sector:"–§–∏–Ω–∞–ª",
      title:"–ü—Ä—ã–∂–æ–∫ –∫ —Ü–µ–Ω—Ç—Ä—É –ì–∞–ª–∞–∫—Ç–∏–∫–∏",
      text:`–¶–µ–Ω—Ç—Ä –ì–∞–ª–∞–∫—Ç–∏–∫–∏ —Ä—è–¥–æ–º.
–°–∏—Å—Ç–µ–º—ã –≥—É–¥—è—Ç –Ω–∞ –ø—Ä–µ–¥–µ–ª–µ.`,
      choices: []
    }
  };

  const randomEvents = {
    R1: { id:"R1", sector:"–°–∏–≥–Ω–∞–ª", title:"–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å–∏–≥–Ω–∞–ª –∫–ª–∏–µ–Ω—Ç–∞",
      text:`–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å–∏–≥–Ω–∞–ª –ø—Ä–æ—Ä—ã–≤–∞–µ—Ç—Å—è –≤ —ç—Ñ–∏—Ä.`,
      choices:[
        { label:"–í–∑—è—Ç—å —Å—Ä–æ—á–Ω–æ –Ω–∞ —Å–µ–±—è", dp:10, ds:15 },
        { label:"–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å —Å —á—ë—Ç–∫–∏–º–∏ —Ä–∞–º–∫–∞–º–∏", dp:5, ds:0 },
        { label:"–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å", fatal:true, fatalReason:"–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞.\n–ú–∏—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞." }
      ]
    },
    R2: { id:"R2", sector:"–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è", title:"–ö–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥–∏—Å—Ç—ã —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π",
      text:`–ü–æ—è–≤–ª—è–µ—Ç—Å—è "–º–∞–ª–µ–Ω—å–∫–∞—è –ø—Ä–æ—Å—å–±–∞", –Ω–æ –∑–∞ –Ω–µ–π —Ö–≤–æ—Å—Ç.`,
      choices:[
        { label:"–û—Ç–∫–∞–∑–∞—Ç—å –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã", dp:0, ds:-5 },
        { label:"–°–æ–≥–ª–∞—Å–∏—Ç—å—Å—è –∏ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –æ–±—ä—ë–º –ø–∏—Å—å–º–µ–Ω–Ω–æ", dp:5, ds:10 },
        { label:"–°–æ–≥–ª–∞—Å–∏—Ç—å—Å—è –±–µ–∑ —Ñ–∏–∫—Å–∞—Ü–∏–∏", dp:10, ds:15, setFlag:{fuzzy_requirements:true} }
      ]
    },
    R4: { id:"R4", sector:"–ö–æ–º–∞–Ω–¥—ã", title:"–ö–æ–Ω—Ñ–ª–∏–∫—Ç –∫–æ–º–∞–Ω–¥",
      text:`–ö–æ–º–∞–Ω–¥—ã —Å–ø–æ—Ä—è—Ç –∑–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç.`,
      choices:[
        { label:"–†–∞–∑–≤–µ—Å—Ç–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å", dp:5, ds:5 },
        { label:"–ü—Ä–æ–¥–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ–º —Ä–æ–ª–∏", dp:5, ds:15 },
        { label:"–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å", prob:{ p:0.25, success:{dp:0,ds:10}, fail:{fatal:true,fatalReason:"–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞.\n–°—Ä—ã–≤ –º–∏—Å—Å–∏–∏."}}}
      ]
    },
    R7: { id:"R7", sector:"–ù–∞–≤–∏–≥–∞—Ü–∏—è", title:"–ü–æ–ª–æ–º–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏",
      text:`–î–∞—Ç—á–∏–∫–∏ –¥–∞—é—Ç –¥—Ä–µ–π—Ñ.`,
      choices:[
        { label:"–ü–æ—á–∏–Ω–∏—Ç—å —Ç—â–∞—Ç–µ–ª—å–Ω–æ –∏ —É–±—Ä–∞—Ç—å —Ä–∏—Å–∫", dp:5, ds:-5 },
        { label:"–°–¥–µ–ª–∞—Ç—å –±—ã—Å—Ç—Ä—ã–π –∫–æ—Å—Ç—ã–ª—å", dp:10, ds:10 }
      ]
    },
    R8: { id:"R8", sector:"–ê—É–¥–∏—Ç", title:"–í–Ω–µ—à–Ω–∏–π –∞—É–¥–∏—Ç",
      text:`–ü—Ä–∏—à—ë–ª –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞—É–¥–∏—Ç.`,
      choices:[
        { label:"–ß–µ—Å—Ç–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å", dp:10, ds:5, setFlag:{audit_risk:false} },
        { label:"–ò–º–ø—Ä–æ–≤–∏–∑–∏—Ä–æ–≤–∞—Ç—å", prob:{ p:0.2, success:{dp:10,ds:0}, fail:{fatal:true,fatalReason:"–ê—É–¥–∏—Ç –≤—Å–∫—Ä—ã–ª —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è.\n–ú–∏—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞."}}}
      ]
    }
  };

  function getNodeById(id){ return nodes[id] || randomEvents[id] || null; }

  // =====================
  // Map layout
  // =====================
  const NODE_POS = {
    E1:  {x: 160, y: 350},
    E2:  {x: 280, y: 240},
    E3:  {x: 380, y: 470},
    E4:  {x: 520, y: 320},
    E5A: {x: 610, y: 230},
    E6A: {x: 690, y: 450},
    E5B: {x: 640, y: 500},
    E6B: {x: 760, y: 300},
    E7:  {x: 820, y: 360},
    E8:  {x: 930, y: 240},
    E9:  {x: 980, y: 470},
    E10: {x: 1080,y: 340},
    E11: {x: 1140,y: 300},

    R1:  {x: 560, y: 170},
    R2:  {x: 760, y: 560},
    R4:  {x: 820, y: 200},
    R7:  {x: 1010,y: 230},
    R8:  {x: 1040,y: 540},
  };
  const EXIT_POS = {x: 1180, y: 300};

  // =====================
  // SVG helpers
  // =====================
  const SVG_NS = "http://www.w3.org/2000/svg";
  const el = (name, attrs={}, text=null) => {
    const n = document.createElementNS(SVG_NS, name);
    for (const [k,v] of Object.entries(attrs)) n.setAttribute(k, String(v));
    if (text != null) n.textContent = text;
    return n;
  };
  const clear = (node) => { while(node.firstChild) node.removeChild(node.firstChild); };

  function diamond(x,y, color, size=10, glow="glowA"){
    const g = el("g", { transform:`translate(${x} ${y})`, filter:`url(#${glow})`, "pointer-events":"none" });
    g.appendChild(el("path", {
      d: `M 0 ${-size} L ${size} 0 L 0 ${size} L ${-size} 0 Z`,
      fill: color,
      stroke: "rgba(0,0,0,.35)",
      "stroke-width":"1"
    }));
    return g;
  }

  function circle(x,y, r, fill, stroke, sw=1, glow=null){
    return el("circle", {
      cx:x, cy:y, r,
      fill, stroke,
      "stroke-width": String(sw),
      filter: glow ? `url(#${glow})` : "none"
    });
  }

  // =====================
  // Zoom/Pan via viewBox (stable)
  // =====================
  const vb = { x:0, y:0, w:1200, h:700 };
  const vbMinW = 420;   // max zoom-in
  const vbMaxW = 1600;  // max zoom-out
  let dragging = false;
  let dragStart = { cx:0, cy:0, x:0, y:0 };

  function applyViewBox(){
    ui.svg.setAttribute("viewBox", `${vb.x} ${vb.y} ${vb.w} ${vb.h}`);
  }

  function clientToSvg(clientX, clientY){
    const pt = ui.svg.createSVGPoint();
    pt.x = clientX; pt.y = clientY;
    const ctm = ui.svg.getScreenCTM();
    if (!ctm) return {x:0,y:0};
    return pt.matrixTransform(ctm.inverse());
  }

  ui.svg.addEventListener("wheel", (e) => {
    e.preventDefault();
    const zoomFactor = (e.deltaY < 0) ? 0.92 : 1.08; // trackpad-friendly

    const p = clientToSvg(e.clientX, e.clientY);

    const nextW = clamp(vb.w * zoomFactor, vbMinW, vbMaxW);
    const nextH = nextW * (700/1200);

    // keep point under cursor
    const kx = (p.x - vb.x) / vb.w;
    const ky = (p.y - vb.y) / vb.h;

    vb.x = p.x - kx * nextW;
    vb.y = p.y - ky * nextH;
    vb.w = nextW;
    vb.h = nextH;

    applyViewBox();
  }, { passive:false });

  ui.svg.addEventListener("pointerdown", (e) => {
    dragging = true;
    dragStart.cx = e.clientX;
    dragStart.cy = e.clientY;
    dragStart.x = vb.x;
    dragStart.y = vb.y;
    ui.svg.setPointerCapture(e.pointerId);
  });

  ui.svg.addEventListener("pointermove", (e) => {
    if (!dragging) return;
    const dx = e.clientX - dragStart.cx;
    const dy = e.clientY - dragStart.cy;

    // convert screen delta to svg delta
    const scaleX = vb.w / ui.svg.clientWidth;
    const scaleY = vb.h / ui.svg.clientHeight;

    vb.x = dragStart.x - dx * scaleX;
    vb.y = dragStart.y - dy * scaleY;
    applyViewBox();
  });

  ui.svg.addEventListener("pointerup", (e) => {
    dragging = false;
    try{ ui.svg.releasePointerCapture(e.pointerId); }catch(_){}
  });

  // =====================
  // End checks
  // =====================
  function endIfNeeded(){
    if (state.stress >= 100){
      openQuiz({
        sector:"–§–∏–Ω–∞–ª",
        title:"–°–∏—Å—Ç–µ–º—ã –æ—Ç–∫–∞–∑–∞–ª–∏",
        text:"–ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º.\n–°—Ç—Ä–µ—Å—Å —ç–∫–∏–ø–∞–∂–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π.\n–ö–æ—Ä–∞–±–ª—å —É—Ö–æ–¥–∏—Ç –≤ –¥—Ä–µ–π—Ñ.",
        choices:[{ label:"–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ü–∏–∫–ª", _action: () => resetGame() }]
      }, { kind:"bad" });
      return true;
    }
    if (state.progress >= 100){
      openQuiz({
        sector:"–§–∏–Ω–∞–ª",
        title:"–ü—Ä—ã–∂–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω",
        text:"–ö–æ—Ä–∞–±–ª—å –¥–æ—Å—Ç–∏–≥–∞–µ—Ç —Ü–µ–Ω—Ç—Ä–∞ –ì–∞–ª–∞–∫—Ç–∏–∫–∏.\n–ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.\n–§–ª–æ—Ç –ø—Ä–∏–∑–Ω–∞—ë—Ç —Ç–µ–±—è –ö–∞–ø–∏—Ç–∞–Ω–æ–º –º–∞—Ä—à—Ä—É—Ç–∞.",
        choices:[{ label:"–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ü–∏–∫–ª", _action: () => resetGame() }]
      }, { kind:"good" });
      return true;
    }
    return false;
  }

  function maybeInsertRandom(nextId){
    if (state.pendingReturn) return nextId;

    state.stepsSinceRandom++;
    if (state.stepsSinceRandom < 2) return nextId;

    state.stepsSinceRandom = 0;
    state.pendingReturn = nextId;

    const pool = Object.keys(randomEvents);
    if (state.flags.asteroid_possible && chance(0.45)) return "R1";
    if (state.flags.fuzzy_requirements && chance(0.35)) return chance(0.5) ? "R2" : "R4";
    return pool[rnd(0, pool.length - 1)];
  }

  // =====================
  // Modal
  // =====================
  function openQuiz(payload, { kind="" } = {}){
    setTag(kind, payload.sector || "–°–µ–∫—Ç–æ—Ä");
    ui.qTitle.textContent = payload.title || "";
    ui.qText.textContent = payload.text || "";
    ui.qChoices.innerHTML = "";

    for (const c of (payload.choices || [])){
      const btn = document.createElement("button");
      btn.textContent = c.label;
      btn.addEventListener("click", () => c._action && c._action());
      ui.qChoices.appendChild(btn);
    }
    ui.modalBack.style.display = "flex";
  }
  function closeQuiz(){ ui.modalBack.style.display = "none"; }

  // =====================
  // Availability logic
  // =====================
  function setAvailable(ids){
    state.available = new Set(ids);
    state.available.add(state.currentNode);
    renderMap();
  }
  function queueNext(nextId){
    const injected = maybeInsertRandom(nextId);
    setAvailable([injected]);
  }
  function queueAfterRandomReturn(){
    const pending = state.pendingReturn;
    state.pendingReturn = null;
    if (pending) queueNext(pending);
    else setAvailable([state.currentNode]);
  }

  // =====================
  // Travel animation
  // =====================
  function animateShip(from, to, ms, done){
    const start = performance.now();
    const ease = (t) => (t<0.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2);

    function frame(now){
      const t = clamp((now - start) / ms, 0, 1);
      const k = ease(t);
      const x = from.x + (to.x - from.x) * k;
      const y = from.y + (to.y - from.y) * k;

      clear(ui.shipLayer);
      ui.shipLayer.appendChild(makeShipAt(x,y,false));

      if (t < 1) requestAnimationFrame(frame);
      else done();
    }
    requestAnimationFrame(frame);
  }

  // =====================
  // Render
  // =====================
  function makeShipAt(x,y, withLabel=false){
    const g = el("g", { transform:`translate(${x} ${y})`, filter:"url(#glowB)", "pointer-events":"none" });
    g.appendChild(circle(0,0, 11, "rgba(76,201,240,.18)", "rgba(76,201,240,.75)", 2));
    g.appendChild(el("path",{
      d:"M -2 -8 L 12 0 L -2 8 Z",
      fill:"rgba(76,201,240,.95)",
      stroke:"rgba(0,0,0,.35)",
      "stroke-width":"1"
    }));
    if (withLabel){
      g.appendChild(el("text",{
        x:16, y:-10,
        fill:"rgba(231,240,255,.85)",
        "font-size":"12",
        "font-family":"ui-monospace, Menlo, Consolas, monospace"
      }, `${state.progress}%`));
    }
    return g;
  }

  function renderMap(){
    clear(ui.beaconsLayer);
    clear(ui.shipLayer);
    clear(ui.exitLayer);

    // Exit marker
    ui.exitLayer.appendChild(diamond(EXIT_POS.x, EXIT_POS.y, "rgba(124,255,124,.95)", 14, "glowB"));
    ui.exitLayer.appendChild(el("text",{
      x: EXIT_POS.x - 10, y: EXIT_POS.y - 20,
      fill:"rgba(231,240,255,.80)",
      "font-size":"12",
      "font-family":"ui-monospace, Menlo, Consolas, monospace",
      "pointer-events":"none"
    }, "100"));

    const allIds = Object.keys(NODE_POS);

    for (const id of allIds){
      const p = NODE_POS[id];
      const isVisited = state.visited.has(id);
      const isAvailable = state.available.has(id);
      const isCurrent = state.currentNode === id;

      const node = getNodeById(id);
      const isRandom = !!(node && node.id && node.id.startsWith("R"));

      let color = "rgba(220,235,255,.22)";
      let size = 7;
      let glow = "glowA";

      if (isVisited){ color = "rgba(220,235,255,.32)"; size = 8; }
      if (isAvailable){ color = "rgba(76,201,240,.95)"; size = 12; glow = "glowB"; }
      if (isRandom && isAvailable){ color = "rgba(255,209,102,.95)"; }
      if (isCurrent){ color = "rgba(76,201,240,.95)"; size = 10; glow = "glowB"; }

      // Visual beacon (non-interactive)
      const beacon = diamond(p.x, p.y, color, size, glow);
      if (isAvailable && !state.isTraveling) beacon.classList.add("pulse");
      ui.beaconsLayer.appendChild(beacon);

      // Current ring
      if (isCurrent){
        ui.beaconsLayer.appendChild(circle(p.x, p.y, 16, "rgba(76,201,240,.07)", "rgba(76,201,240,.35)", 2, "glowA"));
      }

      // HIT ZONE (interactive)
      const hit = circle(p.x, p.y, 24, "transparent", "transparent", 1, null);
      hit.setAttribute("data-id", id);

      if (isAvailable && !state.isTraveling){
        hit.setAttribute("pointer-events", "all");
        hit.style.cursor = "pointer";

        const onClick = (e) => { e.stopPropagation(); travelTo(id); };
        hit.addEventListener("pointerdown", (e)=> e.stopPropagation());
        hit.addEventListener("click", onClick);

        hit.setAttribute("tabindex","0");
        hit.setAttribute("role","button");
        hit.setAttribute("aria-label","–ü–µ—Ä–µ–ª–µ—Ç–µ—Ç—å –≤ —Å–µ–∫—Ç–æ—Ä");
        hit.addEventListener("keydown", (e)=>{ if(e.key==="Enter") travelTo(id); });
      } else {
        hit.setAttribute("pointer-events", "none");
      }

      ui.beaconsLayer.appendChild(hit);
    }

    // ship at current
    const shipPos = NODE_POS[state.currentNode] || NODE_POS["E1"];
    ui.shipLayer.appendChild(makeShipAt(shipPos.x, shipPos.y, false));
  }

  // =====================
  // Travel + quiz
  // =====================
  function travelTo(nodeId){
    if (state.isTraveling) return;
    if (!state.available.has(nodeId)) return;

    const from = NODE_POS[state.currentNode] || NODE_POS["E1"];
    const to = NODE_POS[nodeId] || from;

    state.isTraveling = true;
    renderMap();

    animateShip(from, to, 520, () => {
      state.isTraveling = false;
      state.currentNode = nodeId;
      state.visited.add(nodeId);
      renderMap();
      openNodeQuiz(getNodeById(nodeId));
    });
  }

  function openNodeQuiz(node){
    if (!node) return;

    if (node.id === "E11"){
      const kind = (state.progress >= 85 && state.stress < 80) ? "good" : (state.stress >= 80 ? "bad" : "warn");
      openQuiz({
        sector: node.sector,
        title: node.title,
        text: node.text + "\n\n–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:",
        choices: [
          {
            label:"–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—ã –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä—ã–∂–æ–∫",
            _action: () => {
              closeQuiz();
              applyDelta(10, 10);
              if (endIfNeeded()) return;
              state.pendingReturn = "E11";
              setAvailable(["R7"]);
            }
          },
          {
            label:"–°–¥–µ–ª–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∫–∞–ª–∏–±—Ä–æ–≤–∫—É",
            _action: () => {
              closeQuiz();
              applyDelta(5, -5);
              if (endIfNeeded()) return;
              state.pendingReturn = "E11";
              const pick = state.flags.audit_risk && chance(0.5) ? "R8" : (["R1","R2","R4","R7"][rnd(0,3)]);
              setAvailable([pick]);
            }
          }
        ]
      }, { kind });
      return;
    }

    const isRandom = node.id.startsWith("R");
    const kind = isRandom ? "warn" : "";

    const prepared = (node.choices || []).map(c => ({
      label: c.label,
      _action: () => {
        closeQuiz();

        if (c.fatal){
          state.stress = 100;
          updateBars();
          openQuiz({
            sector:"–§–∏–Ω–∞–ª",
            title:"–°–∏—Å—Ç–µ–º—ã –æ—Ç–∫–∞–∑–∞–ª–∏",
            text: c.fatalReason || "–ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞.",
            choices:[{ label:"–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ü–∏–∫–ª", _action: () => resetGame() }]
          }, { kind:"bad" });
          return;
        }

        if (c.setFlag) for (const [k,v] of Object.entries(c.setFlag)) state.flags[k] = v;

        if (c.prob){
          const branch = chance(c.prob.p) ? c.prob.success : c.prob.fail;

          if (branch.setFlag) for (const [k,v] of Object.entries(branch.setFlag)) state.flags[k] = v;

          if (branch.fatal){
            state.stress = 100;
            updateBars();
            openQuiz({
              sector:"–§–∏–Ω–∞–ª",
              title:"–°–∏—Å—Ç–µ–º—ã –æ—Ç–∫–∞–∑–∞–ª–∏",
              text: branch.fatalReason || "–ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞.",
              choices:[{ label:"–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ü–∏–∫–ª", _action: () => resetGame() }]
            }, { kind:"bad" });
            return;
          }

          applyDelta(branch.dp||0, branch.ds||0);
          if (endIfNeeded()) return;

          if (branch.next) queueNext(branch.next);
          else queueAfterRandomReturn();
          return;
        }

        applyDelta(c.dp||0, c.ds||0);
        if (c.addStressLater) state.flags.audit_risk = true;

        if (endIfNeeded()) return;

        if (c.next) queueNext(c.next);
        else queueAfterRandomReturn();
      }
    }));

    openQuiz({
      sector: node.sector,
      title: node.title,
      text: node.text,
      choices: prepared
    }, { kind });
  }

  // =====================
  // Reset
  // =====================
  function resetGame(){
    state.progress = 0;
    state.stress = 20;
    state.cycle += 1;
    state.flags = { asteroid_possible:false, fuzzy_requirements:false, audit_risk:false };
    state.stepsSinceRandom = 0;
    state.pendingReturn = null;
    state.currentNode = "E1";
    state.visited = new Set(["E1"]);
    state.available = new Set(["E1"]);
    state.isTraveling = false;

    // reset viewbox
    vb.x = 0; vb.y = 0; vb.w = 1200; vb.h = 700;
    applyViewBox();

    closeQuiz();
    updateBars();
    renderMap();
  }

  // =====================
  // Boot
  // =====================
  updateBars();
  applyViewBox();
  renderMap();
})();
</script>
</body>
</html>
