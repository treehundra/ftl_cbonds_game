<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cbonds: –ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –∫–≤–∏–∑</title>

  <style>
    :root{
      --bg0:#02040a;
      --panel: rgba(8,14,28,.72);
      --panel2: rgba(10,18,34,.84);
      --stroke: rgba(120,160,255,.20);
      --text: #e7f0ff;
      --muted:#a6b7d8;

      --accent:#4cc9f0;
      --good:#7CFF7C;
      --bad:#ff4d6d;
      --warn:#ffd166;

      --nodeIdle: rgba(220,235,255,.22);
      --nodeVisited: rgba(220,235,255,.38);
      --nodeAvailable: rgba(76,201,240,.95);
      --nodeExit: rgba(124,255,124,.95);

      --shadow: 0 24px 80px rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1000px 700px at 30% 20%, rgba(76,201,240,.16), transparent 62%),
        radial-gradient(900px 650px at 70% 40%, rgba(124,255,124,.10), transparent 65%),
        radial-gradient(1100px 800px at 50% 120%, rgba(255,77,109,.09), transparent 70%),
        linear-gradient(180deg, #07132a, #030611);
      overflow:hidden;
      color:var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* Fullscreen map background */
    .mapStage{
      position:fixed;
      inset:0;
      background:
        radial-gradient(1200px 800px at 20% 20%, rgba(0,0,0,.35), transparent 62%),
        radial-gradient(900px 700px at 80% 55%, rgba(0,0,0,.25), transparent 60%),
        url("assets/map.png");
      background-size: cover;
      background-position:center;
      filter: saturate(1.05) contrast(1.05);
      pointer-events:none;
    }

    .stars{
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image:
        radial-gradient(1px 1px at 12% 22%, rgba(255,255,255,.60) 50%, transparent 51%),
        radial-gradient(1px 1px at 67% 18%, rgba(255,255,255,.50) 50%, transparent 51%),
        radial-gradient(1px 1px at 32% 78%, rgba(255,255,255,.40) 50%, transparent 51%),
        radial-gradient(1px 1px at 85% 63%, rgba(255,255,255,.45) 50%, transparent 51%),
        radial-gradient(1px 1px at 45% 40%, rgba(255,255,255,.30) 50%, transparent 51%),
        radial-gradient(1px 1px at 8% 88%, rgba(255,255,255,.25) 50%, transparent 51%),
        radial-gradient(1px 1px at 92% 90%, rgba(255,255,255,.30) 50%, transparent 51%);
      opacity:.85;
      animation: drift 18s linear infinite;
      filter: drop-shadow(0 0 10px rgba(255,255,255,.10));
    }
    @keyframes drift{
      from{ transform: translateY(0); }
      to{ transform: translateY(18px); }
    }

    /* Watermark logo */
    .logo{
      position:fixed;
      right:18px;
      bottom:18px;
      width: 300px;
      height: 80px;
      opacity:.16;
      pointer-events:none;
      filter: drop-shadow(0 10px 24px rgba(0,0,0,.55));
      background: url("assets/cbonds.png");
      background-size: contain;
      background-repeat:no-repeat;
      background-position:right bottom;
    }

    /* Fullscreen SVG map (clickable) */
    #mapSvg{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      display:block;
      pointer-events:auto; /* important */
    }

    .clickable{ cursor:pointer; }
    .noSelect{ user-select:none; -webkit-user-select:none; }

    /* HUD */
    .hudTop{
      position:fixed;
      top:18px;
      left:18px;
      right:18px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      pointer-events:none;
    }

    .brand, .stats{
      pointer-events:auto;
      border:1px solid var(--stroke);
      background: var(--panel);
      backdrop-filter: blur(10px);
      border-radius:16px;
      box-shadow: var(--shadow);
    }

    .brand{
      max-width: 560px;
      padding:14px 16px;
    }
    .brand h1{
      margin:0 0 6px 0;
      font-size:16px;
      color: var(--accent);
      letter-spacing:.3px;
    }
    .brand p{
      margin:0;
      font-size:12px;
      color: var(--muted);
      line-height:1.5;
    }

    .stats{
      min-width: 280px;
      padding:14px 16px;
    }
    .statRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      color: var(--muted);
      margin-bottom:8px;
    }
    .bar{
      height:10px;
      border-radius:999px;
      border:1px solid rgba(120,160,255,.18);
      background: rgba(2,6,16,.55);
      overflow:hidden;
      margin-bottom:14px;
    }
    .fill{ height:100%; width:0%; transition: width .25s ease; }
    .fill.progress{ background: linear-gradient(90deg, rgba(124,255,124,.85), rgba(76,201,240,.75)); }
    .fill.stress{ background: linear-gradient(90deg, rgba(255,77,109,.85), rgba(255,209,102,.55)); }

    /* Modal (quiz) */
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(4px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index: 50;
    }
    .modal{
      width: min(720px, 100%);
      border:1px solid var(--stroke);
      background: var(--panel2);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:16px 16px 14px 16px;
    }
    .modalTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:11px;
      color: var(--muted);
      text-transform:uppercase;
      letter-spacing:.35px;
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 12px rgba(76,201,240,.55);
    }
    .dot.good{ background: var(--good); box-shadow: 0 0 12px rgba(124,255,124,.45); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 12px rgba(255,209,102,.35); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 12px rgba(255,77,109,.40); }

    .meta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size:12px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(120,160,255,.18);
      background: rgba(2,6,16,.40);
    }
    .pill b{ color: var(--text); }

    .qTitle{ margin:0 0 8px 0; font-size:15px; line-height:1.25; }
    .qText{ margin:0; font-size:13px; line-height:1.55; white-space:pre-wrap; color: rgba(231,240,255,.95); }

    .choices{
      margin-top:12px;
      display:grid;
      gap:10px;
    }
    .choices button{
      width:100%;
      text-align:left;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(120,160,255,.18);
      background: rgba(2,6,16,.48);
      color: var(--text);
      cursor:pointer;
      font: inherit;
      transition: transform .06s ease, border-color .12s ease, background .12s ease;
    }
    .choices button:hover{
      border-color: rgba(76,201,240,.35);
      background: rgba(6,14,30,.55);
    }
    .choices button:active{ transform: translateY(1px); }

    .modalHint{
      margin-top:10px;
      font-size:12px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    /* small screens */
    @media (max-width: 780px){
      .hudTop{ flex-direction:column; align-items:stretch; }
      .stats{ min-width: unset; }
      .logo{ width: 220px; height: 64px; opacity:.14; }
    }
  </style>
</head>

<body>
  <div class="mapStage" aria-hidden="true"></div>
  <div class="stars" aria-hidden="true"></div>

  <!-- FULLSCREEN MAP SVG -->
  <svg id="mapSvg" viewBox="0 0 1200 700" preserveAspectRatio="xMidYMid slice" role="img" aria-label="–ö–∞—Ä—Ç–∞ —Å–µ–∫—Ç–æ—Ä–æ–≤">
    <defs>
      <filter id="glowA" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur stdDeviation="3" result="blur"/>
        <feMerge>
          <feMergeNode in="blur"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
      <filter id="glowB" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur stdDeviation="7" result="blur"/>
        <feMerge>
          <feMergeNode in="blur"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>

      <style>
        .pulse {
          animation: pulse 1.35s ease-in-out infinite;
          transform-origin: center;
        }
        @keyframes pulse{
          0%,100%{ opacity: .75; transform: scale(1); }
          50%{ opacity: 1; transform: scale(1.08); }
        }
      </style>
    </defs>

    <g id="beaconsLayer"></g>
    <g id="shipLayer"></g>
    <g id="exitLayer"></g>
  </svg>

  <!-- HUD -->
  <div class="hudTop" aria-hidden="false">
    <div class="brand">
      <h1>Cbonds: –ü–æ–ª—ë—Ç –∫ —Ü–µ–Ω—Ç—Ä—É –ì–∞–ª–∞–∫—Ç–∏–∫–∏</h1>
      <p>–ö–ª–∏–∫–∞–π—Ç–µ –ø–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º —Å–µ–∫—Ç–æ—Ä–∞–º. –ü–æ—Å–ª–µ –ø–µ—Ä–µ–ª—ë—Ç–∞ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Å—Ç—Ä–µ—Å—Å.</p>
    </div>

    <div class="stats">
      <div class="statRow"><span>üöÄ –ü—Ä–æ–≥—Ä–µ—Å—Å</span><span id="progressNum">0 / 100</span></div>
      <div class="bar"><div class="fill progress" id="progressFill"></div></div>

      <div class="statRow"><span>‚ö†Ô∏è –°—Ç—Ä–µ—Å—Å</span><span id="stressNum">20 / 100</span></div>
      <div class="bar" style="margin-bottom:0;"><div class="fill stress" id="stressFill"></div></div>
    </div>
  </div>

  <div class="logo" aria-hidden="true"></div>

  <!-- MODAL QUIZ -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-label="–°–æ–±—ã—Ç–∏–µ">
    <div class="modal">
      <div class="modalTop">
        <div class="tag"><span id="tagDot" class="dot"></span><span id="tagText">–°–µ–∫—Ç–æ—Ä</span></div>
        <div class="meta">
          <span class="pill">–¶–∏–∫–ª: <b id="cycle">1</b></span>
          <span class="pill">–ü—Ä–∏–ª–µ—Ç–µ–ª–∏</span>
        </div>
      </div>

      <h2 class="qTitle" id="qTitle">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</h2>
      <p class="qText" id="qText"></p>

      <div class="choices" id="qChoices"></div>

      <div class="modalHint">
        <span>–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –æ–∫–Ω–æ –∑–∞–∫—Ä–æ–µ—Ç—Å—è, –∏ –ø–æ—è–≤—è—Ç—Å—è –Ω–æ–≤—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞.</span>
        <span>–§–∏–Ω–∏—à ‚Äî –∫—Ä–∞–π–Ω—è—è –ø—Ä–∞–≤–∞—è —Ç–æ—á–∫–∞ (100).</span>
      </div>
    </div>
  </div>

<script>
(() => {
  // ============
  // STATE
  // ============
  const state = {
    progress: 0,
    stress: 20,
    cycle: 1,
    flags: {
      asteroid_possible: false,
      fuzzy_requirements: false,
      audit_risk: false
    },
    stepsSinceRandom: 0,
    pendingReturn: null,
    currentNode: "E1",   // where ship is
    visited: new Set(["E1"]),
    available: new Set(["E1"]), // clickable beacons right now
    // travel lock
    isTraveling: false
  };

  // ============
  // UI
  // ============
  const ui = {
    beaconsLayer: document.getElementById("beaconsLayer"),
    shipLayer: document.getElementById("shipLayer"),
    exitLayer: document.getElementById("exitLayer"),

    progressFill: document.getElementById("progressFill"),
    stressFill: document.getElementById("stressFill"),
    progressNum: document.getElementById("progressNum"),
    stressNum: document.getElementById("stressNum"),

    modalBack: document.getElementById("modalBack"),
    tagDot: document.getElementById("tagDot"),
    tagText: document.getElementById("tagText"),
    cycle: document.getElementById("cycle"),
    qTitle: document.getElementById("qTitle"),
    qText: document.getElementById("qText"),
    qChoices: document.getElementById("qChoices"),
  };

  const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
  const rnd = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
  const chance = (p) => Math.random() < p;

  function updateBars(){
    ui.progressFill.style.width = state.progress + "%";
    ui.stressFill.style.width = state.stress + "%";
    ui.progressNum.textContent = `${state.progress} / 100`;
    ui.stressNum.textContent = `${state.stress} / 100`;
    ui.cycle.textContent = String(state.cycle);
  }

  function setTag(kind, text){
    ui.tagText.textContent = text;
    ui.tagDot.className = "dot" + (kind ? (" " + kind) : "");
  }

  // ============
  // CONTENT (—Ç–≤–æ—è —Å—é–∂–µ—Ç–∫–∞)
  // ============
  const nodes = {
    E1: {
      id:"E1",
      sector:"–û—Ä–±–∏—Ç–∞ –ö–ª–∏–µ–Ω—Ç–æ–≤",
      title:"–ü—Ä–∏—ë–º —Å–∏–≥–Ω–∞–ª–∞ —Å –ø–ª–∞–Ω–µ—Ç—ã –ö–ª–∏–µ–Ω—Ç–æ–≤",
      text:
`–ö–∞–ø–∏—Ç–∞–Ω –ø–æ–ª—É—á–∞–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∏–≥–Ω–∞–ª.
–ö–ª–∏–µ–Ω—Ç—ã —Ç—Ä–µ–±—É—é—Ç –∏–∑–º–µ–Ω–∏—Ç—å –∫—É—Ä—Å. –í —ç—Ñ–∏—Ä–µ ‚Äî —à—É–º: —Å—Ä–æ—á–Ω–æ—Å—Ç—å, —ç–º–æ—Ü–∏–∏ –∏ —Ä–∞—Å–ø–ª—ã–≤—á–∞—Ç—ã–µ –æ–±–µ—â–∞–Ω–∏—è.`,
      choices:[
        { label:"–†–∞–∑–æ–±—Ä–∞—Ç—å —Å–∏–≥–Ω–∞–ª, —Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏", dp:10, ds:5, next:"E2" },
        { label:"–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ–æ–±–µ—â–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ —Å—Ä–æ–∫–∏", dp:15, ds:15, next:"E2" },
        { label:"–û—Ç–ª–æ–∂–∏—Ç—å —Å–∏–≥–Ω–∞–ª –≤ –∞—Ä—Ö–∏–≤ –ì–∞–ª–∞–∫—Ç–∏–∫–∏", dp:-5, ds:-5, setFlag:{asteroid_possible:true}, next:"E2" }
      ]
    },

    E2: {
      id:"E2",
      sector:"–°–æ–≤–µ—Ç –ú–µ–∂–∑–≤—ë–∑–¥–Ω–æ–π –°–≤—è–∑–∏",
      title:"–°–æ–≤–µ—Ç –ú–µ–∂–∑–≤—ë–∑–¥–Ω–æ–π –°–≤—è–∑–∏",
      text:
`–°–æ–±—Ä–∞–ª–∏—Å—å –ì–ª–∞–≤–Ω–æ–∫–æ–º–∞–Ω–¥—É—é—â–∏–π, –û—Å–Ω–æ–≤–∞—Ç–µ–ª—å –í—Å–µ–ª–µ–Ω–Ω–æ–π –∏ –æ—Ñ–∏—Ü–µ—Ä—ã —Å–≤—è–∑–∏.
–¢–µ–±—è —Å–ª—É—à–∞—é—Ç –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ. –£ —Ç–µ–±—è –æ–¥–∏–Ω —à–∞–Ω—Å –∑–∞–¥–∞—Ç—å —Ç–æ–Ω –º–∏—Å—Å–∏–∏.`,
      choices:[
        { label:"–ó–∞—â–∏—Ç–∏—Ç—å —Ü–µ–Ω–Ω–æ—Å—Ç—å –º–∏—Å—Å–∏–∏ —Ü–∏—Ñ—Ä–∞–º–∏ –∏ —Ñ–∞–∫—Ç–∞–º–∏", dp:15, ds:-5, next:"E3" },
        { label:"–î–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–æ–º –∫–ª–∏–µ–Ω—Ç–∞ –±–µ–∑ –º–µ—Ç—Ä–∏–∫", dp:10, ds:10, next:"E3" },
        { label:"–ü—É–±–ª–∏—á–Ω–æ —Å–ø–æ—Ä–∏—Ç—å —Å –ì–ª–∞–≤–Ω–æ–∫–æ–º–∞–Ω–¥—É—é—â–∏–º", fatal:true, fatalReason:"–ü—É–±–ª–∏—á–Ω—ã–π —Å–ø–æ—Ä —Å –ì–ª–∞–≤–Ω–æ–∫–æ–º–∞–Ω–¥—É—é—â–∏–º.\n–ü–æ—Ç–µ—Ä—è –¥–æ–≤–µ—Ä–∏—è –°–æ–≤–µ—Ç–∞.\n–ú–∏—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –µ—â—ë –¥–æ —Å—Ç–∞—Ä—Ç–∞." }
      ]
    },

    E3: {
      id:"E3",
      sector:"–ó–≤—ë–∑–¥–Ω–∞—è –∫–∞—Ä—Ç–∞",
      title:"–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–≤—ë–∑–¥–Ω–æ–π –∫–∞—Ä—Ç—ã –º–∏—Å—Å–∏–π",
      text:
`–ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π –¥–µ—Å—è—Ç–∫–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏ –∑–∞–ø—Ä–æ—Å–æ–≤.
–ö–∞–∂–¥—ã–π ‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–∫—Å–ø–µ–¥–∏—Ü–∏—è. –ù–æ —Ç–æ–ø–ª–∏–≤–∞ –∏ —ç–∫–∏–ø–∞–∂–µ–π –º–∞–ª–æ.`,
      choices:[
        { label:"–ñ—ë—Å—Ç–∫–æ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ –∏ —Ü–µ–Ω–Ω–æ—Å—Ç–∏", dp:15, ds:-5, next:"E4" },
        { label:"–í–∑—è—Ç—å –≤—Å—ë –≤ —Ä–∞–±–æ—Ç—É ‚Äî —Ä–∞–∑–±–µ—Ä—ë–º—Å—è –ø–æ –¥–æ—Ä–æ–≥–µ", dp:10, ds:20, setFlag:{fuzzy_requirements:true}, next:"E4" },
        { label:"–ü–µ—Ä–µ–¥–∞—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—é –∫–æ–º–∞–Ω–¥–∏—Ä–∞–º –æ—Ç—Å–µ–∫–æ–≤", dp:10, ds:10, next:"E4" }
      ]
    },

    E4: {
      id:"E4",
      sector:"–í—ã–±–æ—Ä –∫–æ—Ä–∞–±–ª—è",
      title:"–í—ã–±–æ—Ä —Ç–∏–ø–∞ –∫–æ—Ä–∞–±–ª—è",
      text:
`–ù—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç:
—Ç—è–∂—ë–ª—ã–π –∫—Ä–µ–π—Å–µ—Ä –ö–æ—Ä–ø—É—Å–∞ –†–∞–∑–≤–∏—Ç–∏—è ‚Äî –¥–∞–ª—å–Ω–∏–π –∏ —Å–ª–æ–∂–Ω—ã–π –ø—É—Ç—å,
–∏–ª–∏ –º–∞–Ω—ë–≤—Ä–µ–Ω–Ω—ã–π —à–∞—Ç—Ç–ª IT-—Ñ–ª–æ—Ç–∞ ‚Äî –±—ã—Å—Ç—Ä—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä—ã–∂–∫–∏.`,
      choices:[
        { label:"–í—ã–±—Ä–∞—Ç—å —Ç—è–∂—ë–ª—ã–π –∫—Ä–µ–π—Å–µ—Ä –ö–æ—Ä–ø—É—Å–∞ –†–∞–∑–≤–∏—Ç–∏—è", dp:20, ds:10, next:"E5A" },
        { label:"–í—ã–±—Ä–∞—Ç—å –º–∞–Ω—ë–≤—Ä–µ–Ω–Ω—ã–π —à–∞—Ç—Ç–ª IT-—Ñ–ª–æ—Ç–∞", dp:15, ds:-5, next:"E5B" },
        { label:"–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–∞ –º–∞—Ä—à—Ä—É—Ç–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ", dp:10, ds:25, setFlag:{fuzzy_requirements:true}, next:"E7" }
      ]
    },

    E5A: {
      id:"E5A",
      sector:"–ö–æ—Ä–ø—É—Å –†–∞–∑–≤–∏—Ç–∏—è",
      title:"–°–æ–≤–µ—Ç –ö–æ—Ä–ø—É—Å–∞ –†–∞–∑–≤–∏—Ç–∏—è",
      text:
`–í–µ—Ä—Ö–æ–≤–Ω—ã–π –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –∏ –∏–Ω–∂–µ–Ω–µ—Ä—ã —Å–º–æ—Ç—Ä—è—Ç –Ω–∞ —Ç–µ–±—è –±–µ–∑ —ç–º–æ—Ü–∏–π.
–ò–º –Ω—É–∂–Ω—ã —è—Å–Ω–æ—Å—Ç—å, —Ä–∏—Å–∫–∏ –∏ –≥–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ –∫–æ—Ä–∞–±–ª—å –Ω–µ —Ä–∞–∑–≤–∞–ª–∏—Ç—Å—è –Ω–∞ —Å—Ç–∞—Ä—Ç–µ.`,
      choices:[
        { label:"–ü—Ä–∏–Ω–µ—Å—Ç–∏ –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø–ª–∞–Ω, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ —Ä–∏—Å–∫–∏", dp:15, ds:-5, next:"E6A" },
        { label:"–ü—Ä–∏–π—Ç–∏ —Å –∏–¥–µ–µ–π –±–µ–∑ –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏: '—Ä–∞–∑–±–µ—Ä—ë–º—Å—è –ø–æ –ø—É—Ç–∏'", dp:-10, ds:15, setFlag:{fuzzy_requirements:true}, next:"E6A" },
        { label:"–ü—É–±–ª–∏—á–Ω–æ –æ–±–≤–∏–Ω–∏—Ç—å –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤ –≤ —Ç–æ—Ä–º–æ–∂–µ–Ω–∏–∏", fatal:true, fatalReason:"–ü—É–±–ª–∏—á–Ω—ã–µ –æ–±–≤–∏–Ω–µ–Ω–∏—è –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤.\n–¢–µ–±—è '–æ—Ç—Å—Ç—ã–∫–æ–≤–∞–ª–∏' –æ—Ç –∞–Ω–≥–∞—Ä–∞.\n–ö–æ—Ä–∞–±–ª—å –Ω–µ —Å–æ–±—Ä–∞–Ω. –ú–∏—Å—Å–∏—è —Å–æ—Ä–≤–∞–Ω–∞." }
      ]
    },

    E6A: {
      id:"E6A",
      sector:"–ê–Ω–≥–∞—Ä",
      title:"–û–∂–∏–¥–∞–Ω–∏–µ —Å–±–æ—Ä–∫–∏ –∫–æ—Ä–∞–±–ª—è",
      text:
`–ê–Ω–≥–∞—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω. –ò–Ω–∂–µ–Ω–µ—Ä—ã –∑–∞–Ω—è—Ç—ã —Å–ø–∞—Å–µ–Ω–∏–µ–º –≤—Å–µ–π –ì–∞–ª–∞–∫—Ç–∏–∫–∏.
–ú–æ–∂–Ω–æ –∂–¥–∞—Ç—å, –º–æ–∂–Ω–æ –¥–∞–≤–∏—Ç—å, –º–æ–∂–Ω–æ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ–±–æ–π—Ç–∏ –æ—á–µ—Ä–µ–¥—å.`,
      choices:[
        { label:"–¢–µ—Ä–ø–µ–ª–∏–≤–æ –∂–¥–∞—Ç—å, —É–ª—É—á—à–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –º–∏—Å—Å–∏–∏", dp:10, ds:-5, next:"E7" },
        { label:"–î–∞–≤–∏—Ç—å –∏ —É—Å–∫–æ—Ä—è—Ç—å —Å–±–æ—Ä–∫—É –ª—é–±–æ–π —Ü–µ–Ω–æ–π", dp:15, ds:15, next:"E7" },
        {
          label:"–ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ–±–æ–π—Ç–∏ –æ—á–µ—Ä–µ–¥—å –≤ –∞–Ω–≥–∞—Ä–µ",
          prob: {
            p: 0.5,
            success: { dp:20, ds:0, next:"E7" },
            fail: { fatal:true, fatalReason:"–ü–æ–ø—ã—Ç–∫–∞ –æ–±–æ–π—Ç–∏ –æ—á–µ—Ä–µ–¥—å –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å.\n–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —Å–∫–∞–Ω–¥–∞–ª –≤ –∞–Ω–≥–∞—Ä–µ.\n–ú–∏—Å—Å–∏—è –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∞." }
          }
        }
      ]
    },

    E5B: {
      id:"E5B",
      sector:"–°–æ–≤–µ—Ç –§–ª–æ—Ç–∞",
      title:"–ü—Ä—è–º–æ–π –≤—ã—Ö–æ–¥ –Ω–∞ –°–æ–≤–µ—Ç –§–ª–æ—Ç–∞",
      text:
`–¢—ã –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ –°–æ–≤–µ—Ç–µ –§–ª–æ—Ç–∞.
–ì–ª–∞–≤–Ω–æ–∫–æ–º–∞–Ω–¥—É—é—â–∏–π, –í–µ—Ä—Ö–æ–≤–Ω—ã–π –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –∏ –ê–¥–º–∏—Ä–∞–ª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–π –∂–¥—É—Ç –∑–∞—â–∏—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∞.`,
      choices:[
        { label:"–ö–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É: —Ü–µ–ª—å, –º–µ—Ç—Ä–∏–∫–∞, –ø–ª–∞–Ω, —Ä–∏—Å–∫–∏", dp:15, ds:-5, next:"E6B" },
        { label:"–î–∞–≤–∏—Ç—å —Å—Ä–æ–∫–∞–º–∏: '–Ω—É–∂–Ω–æ –≤—á–µ—Ä–∞'", dp:10, ds:15, next:"E6B" },
        { label:"–í—ã–Ω–µ—Å—Ç–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –Ω–∞ –°–æ–≤–µ—Ç", fatal:true, fatalReason:"–¢—ã –ø—Ä–∏–Ω—ë—Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –≤–æ–π–Ω—É –Ω–∞ –°–æ–≤–µ—Ç –§–ª–æ—Ç–∞.\n–ö–æ–º–∞–Ω–¥–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º–∏—Å—Å–∏—é '–≤ –∫–∞—Ä–∞–Ω—Ç–∏–Ω'.\n–ó–∞–ø—É—Å–∫ –æ—Ç–º–µ–Ω—ë–Ω." }
      ]
    },

    E6B: {
      id:"E6B",
      sector:"–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —à–∞—Ç—Ç–ª–∞",
      title:"–ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ —à–∞—Ç—Ç–ª–∞",
      text:
`–®–∞—Ç—Ç–ª –≥–æ—Ç–æ–≤ –∫ —Å—Ç–∞—Ä—Ç—É, –Ω–æ –≤—Å—ë –¥–µ—Ä–∂–∏—Ç—Å—è –Ω–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫.
–û–¥–Ω–æ —Ç—É–º–∞–Ω–Ω–æ–µ —Å–ª–æ–≤–æ ‚Äî –∏ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è —Å—Ç–∞–Ω–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π.`,
      choices:[
        { label:"–ß—ë—Ç–∫–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –æ–±—ä—ë–º –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏", dp:15, ds:-5, next:"E7" },
        { label:"–û—Å—Ç–∞–≤–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è —Ä–∞–∑–º—ã—Ç—ã–º–∏", dp:10, ds:15, setFlag:{fuzzy_requirements:true}, next:"E7" },
        { label:"–†–∞—Å—à–∏—Ä–∏—Ç—å –æ–±—ä—ë–º '–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π'", dp:5, ds:20, setFlag:{fuzzy_requirements:true}, next:"E7" }
      ]
    },

    E7: {
      id:"E7",
      sector:"–†–∞–∑–±–æ—Ä —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏",
      title:"–†–∞–∑–±–æ—Ä –º–∞—Ä—à—Ä—É—Ç–∞ –ø–æ–ª—ë—Ç–∞",
      text:
`–°–æ–±—Ä–∞–ª–∏—Å—å –∞–¥–º–∏—Ä–∞–ª—ã, –≤–µ–¥—É—â–∏–µ –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä—ã –∏ —Å—Ç–∞—Ä—à–∏–µ –∏–Ω–∂–µ–Ω–µ—Ä—ã.
–ï—Å–ª–∏ –º–∞—Ä—à—Ä—É—Ç –æ–ø–∏—Å–∞–Ω —Ç—É–º–∞–Ω–Ω–æ ‚Äî –º–∏—Å—Å–∏—é –≤–µ—Ä–Ω—É—Ç –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∫–∞–ª–∏–±—Ä–æ–≤–∫—É.`,
      choices:[
        { label:"–£—Ç–æ—á–Ω–∏—Ç—å –∏ –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç –¥–æ —è—Å–Ω–æ—Å—Ç–∏", dp:15, ds:-5, setFlag:{fuzzy_requirements:false}, next:"E8" },
        { label:"–û—Å—Ç–∞–≤–∏—Ç—å —Ç—É–º–∞–Ω: '–≥–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'", dp:-5, ds:15, setFlag:{fuzzy_requirements:true}, next:"E8" },
        { label:"–°–∫–∞–∑–∞—Ç—å: '—Ä–∞–∑–±–µ—Ä—ë—Ç–µ—Å—å –ø–æ —Ö–æ–¥—É'", dp:-10, ds:20, setFlag:{fuzzy_requirements:true}, next:"E8" }
      ]
    },

    E8: {
      id:"E8",
      sector:"–û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏",
      title:"–†–∞—Å—á—ë—Ç —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–∏",
      text:
`–ú–∏—Å—Å–∏—è –ø–æ–ª—É—á–∞–µ—Ç –æ—Ü–µ–Ω–∫—É —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å –∑–∞–ø—É—Å–∫–∞.
–ú–∞–ª–æ —Ä–µ—Å—É—Ä—Å–æ–≤ ‚Äî –±—ã—Å—Ç—Ä—ã–π –ø—Ä—ã–∂–æ–∫. –ú–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å–æ–≤ ‚Äî —ç–∫—Å–ø–µ–¥–∏—Ü–∏—è –Ω–∞ –≥–æ–¥—ã.`,
      choices:[
        { label:"–ß–µ—Å—Ç–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —ç—Ç–∞–ø–Ω–æ—Å—Ç—å", dp:15, ds:-5, next:"E9" },
        { label:"–ó–∞–Ω–∏–∂–∞—Ç—å –æ—Ü–µ–Ω–∫–∏, —á—Ç–æ–±—ã –ø—Ä–æ–±–∏—Ç—å—Å—è –≤ –æ—á–µ—Ä–µ–¥—å", dp:20, ds:15, addStressLater:true, next:"E9" },
        { label:"–ü—Ä–æ–ª–µ–∑—Ç—å –≤–Ω–µ –æ—á–µ—Ä–µ–¥–∏ —á–µ—Ä–µ–∑ –¥–∞–≤–ª–µ–Ω–∏–µ –∏ —Å–≤—è–∑–∏", fatal:true, fatalReason:"–ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ–ª–µ–∑—Ç—å –≤–Ω–µ –æ—á–µ—Ä–µ–¥–∏.\n–ê–¥–º–∏—Ä–∞–ª —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –Ω–∞—Ä—É—à–µ–Ω–∏–µ.\n–ú–∏—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –ø—Ä–∏–∫–∞–∑–æ–º." }
      ]
    },

    E9: {
      id:"E9",
      sector:"–ë–æ–ª—å—à–æ–π –°–æ–≤–µ—Ç",
      title:"–ë–æ–ª—å—à–æ–π –°–æ–≤–µ—Ç",
      text:
`–†–∞–∑ –≤ –¥–≤–µ –Ω–µ–¥–µ–ª–∏ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ë–æ–ª—å—à–æ–π –°–æ–≤–µ—Ç.
–ò–¥—É—Ç —ç–ø–∏—á–µ—Å–∫–∏–µ —Å—Ä–∞–∂–µ–Ω–∏—è –∑–∞ –∫–∞–∂–¥—ã–π —Å–ª–æ—Ç –∑–∞–ø—É—Å–∫–∞.`,
      choices:[
        { label:"–î–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è —Å —Å–æ—é–∑–Ω–∏–∫–∞–º–∏ –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç", dp:20, ds:5, next:"E10" },
        { label:"–ü–æ–π—Ç–∏ –≤ –æ–¥–∏–Ω–æ—á–Ω—ã–π —à—Ç—É—Ä–º –°–æ–≤–µ—Ç–∞", dp:15, ds:15, next:"E10" },
        { label:"–£—Å—Ç—Ä–æ–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∑–∞ —Å–ª–æ—Ç", dp:0, ds:40, next:"E10" }
      ]
    },

    E10: {
      id:"E10",
      sector:"–û–∫–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏",
      title:"–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏",
      text:
`–ü–æ—Å–ª–µ –°–æ–≤–µ—Ç–∞ ‚Äî –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–∫–Ω–æ, —á—Ç–æ–±—ã –º–µ–Ω—è—Ç—å –º–∞—Ä—à—Ä—É—Ç.
–ö–∞–∂–¥–∞—è –ø—Ä–∞–≤–∫–∞ –º–æ–∂–µ—Ç —Å–ø–∞—Å—Ç–∏ –º–∏—Å—Å–∏—é‚Ä¶ –∏–ª–∏ —Å–æ—Ä–≤–∞—Ç—å —Å—Ç–∞—Ä—Ç.`,
      choices:[
        { label:"–í–Ω–µ—Å—Ç–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ –±–µ–∑ —Å—Ä—ã–≤–∞ —Å—Ç–∞—Ä—Ç–∞", dp:10, ds:-5, next:"E11" },
        { label:"–°—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç (scope creep)", dp:10, ds:20, setFlag:{fuzzy_requirements:true}, next:"E11" },
        { label:"–û—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ–ø—Ä–µ–∫–∏ –¥–∞–Ω–Ω—ã–º", dp:-10, ds:20, next:"E11" }
      ]
    },

    E11: {
      id:"E11",
      sector:"–§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä—ã–∂–æ–∫",
      title:"–ü—Ä—ã–∂–æ–∫ –∫ —Ü–µ–Ω—Ç—Ä—É –ì–∞–ª–∞–∫—Ç–∏–∫–∏",
      text:
`–¶–µ–Ω—Ç—Ä –ì–∞–ª–∞–∫—Ç–∏–∫–∏ —Ä—è–¥–æ–º.
–°–∏—Å—Ç–µ–º—ã –≥—É–¥—è—Ç –Ω–∞ –ø—Ä–µ–¥–µ–ª–µ. –õ—é–±–∞—è –æ—à–∏–±–∫–∞ ‚Äî –∏ –∫–æ—Ä–∞–±–ª—å —Ä–∞–∑–æ—Ä–≤—ë—Ç –Ω–∞ –æ—Ä–±–∏—Ç–µ —Å—Ç—Ä–µ—Å—Å–∞.

–í—ã–±–µ—Ä–∏: –ø—Ä—ã–≥–∞—Ç—å —Å–µ–π—á–∞—Å –∏–ª–∏ –∫–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å –µ—â—ë –æ–¥–∏–Ω —Ü–∏–∫–ª.`,
      choices: [] // dynamic
    }
  };

  const randomEvents = {
    R1: {
      id:"R1",
      sector:"–°–∏–≥–Ω–∞–ª",
      title:"–ê—Å—Ç–µ—Ä–æ–∏–¥–Ω—ã–π —Å–∏–≥–Ω–∞–ª –∫–ª–∏–µ–Ω—Ç–∞",
      text:
`–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å–∏–≥–Ω–∞–ª –ø—Ä–æ—Ä—ã–≤–∞–µ—Ç—Å—è –≤ —ç—Ñ–∏—Ä.
–ö—Ä—É–ø–Ω—ã–π –∫–ª–∏–µ–Ω—Ç —Ç—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –º–∞–Ω—ë–≤—Ä–∞ ‚Äî –∏–Ω–∞—á–µ —É–¥–∞—Ä–∏—Ç –ø–æ –æ—Ä–±–∏—Ç–µ.`,
      choices:[
        { label:"–í–∑—è—Ç—å —Å—Ä–æ—á–Ω–æ –Ω–∞ —Å–µ–±—è", dp:10, ds:15 },
        { label:"–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—Ñ–∏—Ü–µ—Ä–∞–º —Å–≤—è–∑–∏ —Å —á—ë—Ç–∫–∏–º–∏ —Ä–∞–º–∫–∞–º–∏", dp:5, ds:0 },
        { label:"–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å ‚Äî '–Ω–µ –ø–æ –ø–ª–∞–Ω—É'", fatal:true, fatalReason:"–¢—ã –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å–∏–≥–Ω–∞–ª.\n–ö–ª–∏–µ–Ω—Ç —Å–Ω–æ—Å–∏—Ç —á–∞—Å—Ç—å –º–∏—Å—Å–∏–π —Å –æ—Ä–±–∏—Ç—ã.\n–ó–∞–ø—É—Å–∫ –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç—Å—è." }
      ]
    },
    R2: {
      id:"R2",
      sector:"–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è",
      title:"–ö–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥–∏—Å—Ç—ã —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π",
      text:
`–ù–∞ —Å—Ç—ã–∫–æ–≤–∫–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è '–º–∞–ª–µ–Ω—å–∫–∞—è –ø—Ä–æ—Å—å–±–∞': –≤—Å–µ–≥–æ –æ–¥–Ω–∞ —Ñ–∏—á–∞.
–ù–æ —É –Ω–µ—ë —Ç–µ–Ω—å ‚Äî –µ—â—ë –¥–µ—Å—è—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –≤ –≥—Ä—É–∑–æ–≤–æ–º –æ—Ç—Å–µ–∫–µ.`,
      choices:[
        { label:"–û—Ç–∫–∞–∑–∞—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã", dp:0, ds:-5 },
        { label:"–°–æ–≥–ª–∞—Å–∏—Ç—å—Å—è, –Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –æ–±—ä—ë–º –ø–∏—Å—å–º–µ–Ω–Ω–æ", dp:5, ds:10 },
        { label:"–°–æ–≥–ª–∞—Å–∏—Ç—å—Å—è –±–µ–∑ —Ñ–∏–∫—Å–∞—Ü–∏–∏ ‚Äî '–ø–æ—Ç–æ–º —Ä–∞–∑–±–µ—Ä—ë–º—Å—è'", dp:10, ds:15, setFlag:{fuzzy_requirements:true} }
      ]
    },
    R3: {
      id:"R3",
      sector:"–î–∞–Ω–Ω—ã–µ",
      title:"–¢—É–º–∞–Ω–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏",
      text:
`–î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É.
–ö–∞–∂–¥–∞—è –º–µ—Ç—Ä–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥—Ä—É–≥—É—é –í—Å–µ–ª–µ–Ω–Ω—É—é. –†–µ—à–µ–Ω–∏–µ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω—É–∂–Ω–æ —Å–µ–π—á–∞—Å.`,
      choices:[
        { label:"–ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–∫—Ç–æ–≤–∫—É", dp:10, ds:0 },
        { label:"–í—ã–±—Ä–∞—Ç—å '—É–¥–æ–±–Ω—ã–µ' —Ü–∏—Ñ—Ä—ã —Ä–∞–¥–∏ —Ä–µ—à–µ–Ω–∏—è", dp:10, ds:10, setFlag:{audit_risk:true} },
        { label:"–û—Ç–ª–æ–∂–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ –¥–æ –∏–¥–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö", dp:-5, ds:5 }
      ]
    },
    R4: {
      id:"R4",
      sector:"–ö–æ–º–∞–Ω–¥—ã",
      title:"–ö–æ–Ω—Ñ–ª–∏–∫—Ç –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤ –æ—Ç—Å–µ–∫–æ–≤",
      text:
`–ö–æ–º–∞–Ω–¥–∏—Ä—ã —Å–ø–æ—Ä—è—Ç: —á–µ–π –æ—Ç—Å–µ–∫ –≤–∞–∂–Ω–µ–µ.
–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Ä–∞–∑–æ–≥—Ä–µ–≤–∞–µ—Ç —Å—Ç—Ä–µ—Å—Å –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º —Ä–µ–∞–∫—Ç–æ—Ä ‚Äî —Ç–æ–ø–ª–∏–≤–æ.`,
      choices:[
        { label:"–°–æ–∑–≤–∞—Ç—å –º–∏–Ω–∏-—Å–æ–≤–µ—Ç –∏ —Ä–∞–∑–≤–µ—Å—Ç–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å", dp:5, ds:5 },
        { label:"–ü—Ä–æ–¥–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ–º —Ä–æ–ª–∏", dp:5, ds:15 },
        {
          label:"–°–¥–µ–ª–∞—Ç—å –≤–∏–¥, —á—Ç–æ –ø—Ä–æ–±–ª–µ–º—ã –Ω–µ—Ç",
          prob: {
            p: 0.25,
            success: { dp:0, ds:10, next:null },
            fail: { fatal:true, fatalReason:"–¢—ã –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª –∫–æ–Ω—Ñ–ª–∏–∫—Ç.\n–û—Ç—Å–µ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å–∞–±–æ—Ç–∏—Ä—É–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É.\n–ú–∏—Å—Å–∏—è —Ä–∞–∑–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º." }
          }
        }
      ]
    },
    R5: {
      id:"R5",
      sector:"–†–µ—Å—É—Ä—Å—ã",
      title:"–ü–æ—Ç–µ—Ä—è –∫–ª—é—á–µ–≤–æ–≥–æ –∏–Ω–∂–µ–Ω–µ—Ä–∞",
      text:
`–ö–ª—é—á–µ–≤–æ–π –∏–Ω–∂–µ–Ω–µ—Ä —É—Ö–æ–¥–∏—Ç –Ω–∞ –¥—Ä—É–≥—É—é –º–∏—Å—Å–∏—é.
–ù—É–∂–Ω–æ –ª–∏–±–æ –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –ø–ª–∞–Ω, –ª–∏–±–æ —Å–ª–æ–º–∞—Ç—å –ª—é–¥–µ–π.`,
      choices:[
        { label:"–ü–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –ø–ª–∞–Ω –∏ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –æ–±—ä—ë–º", dp:5, ds:10 },
        { label:"–î–∞–≤–∏—Ç—å —Å—Ä–æ–∫–∞–º–∏ –∏ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞–º–∏", dp:10, ds:20 },
        { label:"–ó–∞–º–æ—Ä–æ–∑–∏—Ç—å —á–∞—Å—Ç—å –º–∏—Å—Å–∏–∏ —Ä–∞–¥–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏", dp:-5, ds:-5 }
      ]
    },
    R6: {
      id:"R6",
      sector:"–°–æ—é–∑",
      title:"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å–æ—é–∑–Ω–∏–∫",
      text:
`–û—Ñ–∏—Ü–µ—Ä –∏–∑ —Å–æ—Å–µ–¥–Ω–µ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–æ–º–æ—â—å: —Ä–µ—Å—É—Ä—Å—ã –∏ –∫–∞–Ω–∞–ª –∫ –°–æ–≤–µ—Ç—É.
–ù–æ –∑–∞ –ø–æ–º–æ—â—å –≤—Å–µ–≥–¥–∞ –ø–ª–∞—Ç—è—Ç –ø–æ–ª–∏—Ç–∏–∫–æ–π.`,
      choices:[
        { label:"–ü—Ä–∏–Ω—è—Ç—å –ø–æ–º–æ—â—å –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏", dp:10, ds:5 },
        { label:"–û—Ç–∫–∞–∑–∞—Ç—å—Å—è: –¥–µ—Ä–∂–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å", dp:0, ds:0 },
        { label:"–ü–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å —Å–æ—é–∑–Ω–∏–∫–∞ –∏ —Ç—Ä–µ–±–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ", dp:10, ds:10 }
      ]
    },
    R7: {
      id:"R7",
      sector:"–ù–∞–≤–∏–≥–∞—Ü–∏—è",
      title:"–ü–æ–ª–æ–º–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏",
      text:
`–ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–∏ –¥–∞—é—Ç –¥—Ä–µ–π—Ñ.
–ú–æ–∂–Ω–æ –ø–æ—á–∏–Ω–∏—Ç—å —Ç—â–∞—Ç–µ–ª—å–Ω–æ –∏–ª–∏ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –±—ã—Å—Ç—Ä—ã–π –∫–æ—Å—Ç—ã–ª—å.`,
      choices:[
        { label:"–ü–æ—á–∏–Ω–∏—Ç—å —Ç—â–∞—Ç–µ–ª—å–Ω–æ –∏ —É–±—Ä–∞—Ç—å —Ä–∏—Å–∫", dp:5, ds:-5 },
        { label:"–°–¥–µ–ª–∞—Ç—å –±—ã—Å—Ç—Ä—ã–π –∫–æ—Å—Ç—ã–ª—å –∏ –ª–µ—Ç–µ—Ç—å –¥–∞–ª—å—à–µ", dp:10, ds:10 }
      ]
    },
    R8: {
      id:"R8",
      sector:"–ê—É–¥–∏—Ç",
      title:"–í–Ω–µ—à–Ω–∏–π –∞—É–¥–∏—Ç —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏",
      text:
`–ü—Ä–∏—à—ë–ª –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞—É–¥–∏—Ç: —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –ø—Ä–∞–≤–∏–ª–∞–º –∏ –æ–±–µ—â–∞–Ω–∏—è–º.
–ï—Å–ª–∏ —Ç—ã –≥–¥–µ-—Ç–æ '–∑–∞–Ω–∏–∂–∞–ª' —Å–ª–æ–∂–Ω–æ—Å—Ç—å ‚Äî —ç—Ç–æ –≤—Å–ø–ª—ã–≤—ë—Ç.`,
      choices:[
        { label:"–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∏ —á–µ—Å—Ç–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å", dp:10, ds:5, setFlag:{audit_risk:false} },
        {
          label:"–ò–º–ø—Ä–æ–≤–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –Ω–∞–¥–µ—è—Ç—å—Å—è –Ω–∞ —É–¥–∞—á—É",
          prob: {
            p: 0.2,
            success: { dp:10, ds:0, next:null },
            fail: { fatal:true, fatalReason:"–ê—É–¥–∏—Ç –≤—Å–∫—Ä—ã–ª —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è.\n–°–æ–≤–µ—Ç –∑–∞–º–æ—Ä–æ–∑–∏–ª –º–∏—Å—Å–∏—é –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π.\n–ö–æ—Ä–∞–±–ª—å –Ω–µ –ª–µ—Ç–∏—Ç." }
          }
        },
        {
          label:"–°–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ –∏ —É–π—Ç–∏ –æ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤",
          prob: {
            p: 0.15,
            success: { dp:0, ds:20, next:null },
            fail: { fatal:true, fatalReason:"–ü–æ–ø—ã—Ç–∫–∞ —Å–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ –∞—É–¥–∏—Ç–∞.\n–î–æ–≤–µ—Ä–∏–µ –∫ –∫–∞–ø–∏—Ç–∞–Ω—É –ø–æ—Ç–µ—Ä—è–Ω–æ.\n–ú–∏—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞." }
          }
        }
      ]
    }
  };

  // ============
  // MAP GEOMETRY (—Ç–æ–ª—å–∫–æ —Ç–æ—á–∫–∏)
  // ============
  // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ ID –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ –∫–∞—Ä—Ç–µ.
  // –†–∞—Å–∫–ª–∞–¥–∫–∞ ‚Äî "–≥—Ä–∏–¥ –∫–æ–ª–æ–Ω–æ–∫", –Ω–æ –±–µ–∑ –ª–∏–Ω–∏–π, —Ç–æ–ª—å–∫–æ –º–∞—è–∫–∏.
  const NODE_POS = {
    E1:  {x: 140, y: 360},
    E2:  {x: 260, y: 250},
    E3:  {x: 360, y: 460},
    E4:  {x: 480, y: 320},
    E5A: {x: 560, y: 220},
    E6A: {x: 640, y: 430},
    E5B: {x: 580, y: 490},
    E6B: {x: 700, y: 300},
    E7:  {x: 760, y: 360},
    E8:  {x: 880, y: 240},
    E9:  {x: 930, y: 470},
    E10: {x: 1050,y: 340},
    E11: {x: 1120,y: 300},

    // Random events (—Ä–∞—Å–∫–∏–¥–∞–Ω—ã –≤–æ–∫—Ä—É–≥ —Å—Ä–µ–¥–Ω–µ–π/–ø—Ä–∞–≤–æ–π –∑–æ–Ω—ã)
    R1:  {x: 520, y: 170},
    R2:  {x: 690, y: 540},
    R3:  {x: 860, y: 360},
    R4:  {x: 760, y: 200},
    R5:  {x: 920, y: 560},
    R6:  {x: 620, y: 150},
    R7:  {x: 980, y: 230},
    R8:  {x: 1010,y: 530},
  };

  // Exit marker always far right (progress 100)
  const EXIT_POS = {x: 1180, y: 300};

  // ============
  // SVG helpers
  // ============
  const SVG_NS = "http://www.w3.org/2000/svg";
  const el = (name, attrs = {}, text = null) => {
    const n = document.createElementNS(SVG_NS, name);
    for (const [k,v] of Object.entries(attrs)) n.setAttribute(k, String(v));
    if (text != null) n.textContent = text;
    return n;
  };
  const clear = (node) => { while(node.firstChild) node.removeChild(node.firstChild); };

  function diamond(x,y, color, size=10, glow="glowA"){
    const g = el("g", { transform:`translate(${x} ${y})`, filter:`url(#${glow})` });
    g.appendChild(el("path", {
      d: `M 0 ${-size} L ${size} 0 L 0 ${size} L ${-size} 0 Z`,
      fill: color,
      stroke: "rgba(0,0,0,.35)",
      "stroke-width":"1"
    }));
    return g;
  }

  function circle(x,y, r, fill, stroke, sw=1, glow=null){
    return el("circle", {
      cx:x, cy:y, r,
      fill,
      stroke,
      "stroke-width": String(sw),
      filter: glow ? `url(#${glow})` : "none"
    });
  }

  // ============
  // GAME FLOW
  // ============
  function applyDelta(dp=0, ds=0){
    state.progress = clamp(state.progress + dp, 0, 100);
    state.stress   = clamp(state.stress + ds, 0, 100);
    updateBars();
  }

  function endIfNeeded(){
    if (state.stress >= 100){
      openQuiz({
        sector:"–§–∏–Ω–∞–ª",
        title:"–°–∏—Å—Ç–µ–º—ã –æ—Ç–∫–∞–∑–∞–ª–∏",
        text:"–ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º.\n–°—Ç—Ä–µ—Å—Å —ç–∫–∏–ø–∞–∂–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π.\n–ö–æ—Ä–∞–±–ª—å —É—Ö–æ–¥–∏—Ç –≤ –¥—Ä–µ–π—Ñ.",
        choices:[{ label:"–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ü–∏–∫–ª", _action: () => resetGame() }]
      }, { kind:"bad" });
      return true;
    }
    if (state.progress >= 100){
      openQuiz({
        sector:"–§–∏–Ω–∞–ª",
        title:"–ü—Ä—ã–∂–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω",
        text:"–ö–æ—Ä–∞–±–ª—å –¥–æ—Å—Ç–∏–≥–∞–µ—Ç —Ü–µ–Ω—Ç—Ä–∞ –ì–∞–ª–∞–∫—Ç–∏–∫–∏.\n–ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.\n–§–ª–æ—Ç –ø—Ä–∏–∑–Ω–∞—ë—Ç —Ç–µ–±—è –ö–∞–ø–∏—Ç–∞–Ω–æ–º –º–∞—Ä—à—Ä—É—Ç–∞.",
        choices:[{ label:"–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ü–∏–∫–ª", _action: () => resetGame() }]
      }, { kind:"good" });
      return true;
    }
    return false;
  }

  function maybeInsertRandom(nextId){
    if (state.pendingReturn) return nextId;

    state.stepsSinceRandom++;
    if (state.stepsSinceRandom < 2) return nextId;

    state.stepsSinceRandom = 0;
    state.pendingReturn = nextId;

    const pool = Object.keys(randomEvents);
    if (state.flags.asteroid_possible && chance(0.45)) return "R1";
    if (state.flags.fuzzy_requirements && chance(0.35)) return chance(0.5) ? "R2" : "R4";
    return pool[rnd(0, pool.length - 1)];
  }

  function resolveNext(next){
    if (typeof next === "function") return next(state);
    return next;
  }

  // –ü–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –∫–≤–∏–∑–∞ –Ω–∞ —Ç–µ–∫—É—â–µ–º —Å–µ–∫—Ç–æ—Ä–µ ‚Äî –≤—ã—á–∏—Å–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞:
  // —ç—Ç–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ next-id –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞ (—Å —É—á—ë—Ç–æ–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π).
  function computeNextIdsFromNode(node){
    if (!node) return [];

    // –§–∏–Ω–∞–ª—å–Ω—ã–π —É–∑–µ–ª: –≤—ã–±–æ—Ä—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ
    if (node.id === "E11"){
      return ["E11_JUMP", "E11_CALIBRATE"]; // –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ ‚Äú—Å–µ–∫—Ç–æ—Ä–∞-—Ä–µ—à–µ–Ω–∏—è‚Äù (–Ω–∞ –∫–∞—Ä—Ç–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ)
    }

    const ids = new Set();
    for (const c of (node.choices || [])){
      if (c.prob){
        if (c.prob.success && c.prob.success.next) ids.add(resolveNext(c.prob.success.next));
        if (c.prob.fail && c.prob.fail.next) ids.add(resolveNext(c.prob.fail.next));
      } else if (c.next){
        ids.add(resolveNext(c.next));
      } else {
        // random event choices often have no explicit next -> will return to pendingReturn
        // we do nothing here
      }
    }
    return [...ids].filter(Boolean);
  }

  function setAvailable(ids){
    state.available = new Set(ids);
    // –≤—Å–µ–≥–¥–∞ —Ä–∞–∑—Ä–µ—à–∞–µ–º –∫–ª–∏–∫ –ø–æ —Ç–µ–∫—É—â–µ–º—É —Å–µ–∫—Ç–æ—Ä—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–≤–∏–∑
    state.available.add(state.currentNode);
    renderMap();
  }

  // ============
  // TRAVEL + QUIZ
  // ============
  function travelTo(nodeId){
    if (state.isTraveling) return;
    if (!state.available.has(nodeId)) return;

    // –ø–µ—Ä–µ–ª—ë—Ç
    state.isTraveling = true;

    const from = NODE_POS[state.currentNode] || NODE_POS["E1"];
    const to   = (nodeId === "EXIT") ? EXIT_POS : (NODE_POS[nodeId] || from);

    animateShip(from, to, 520, () => {
      state.isTraveling = false;
      state.currentNode = nodeId;
      state.visited.add(nodeId);

      // –æ—Ç–∫—Ä—ã—Ç—å –∫–≤–∏–∑ –ø–æ –ø—Ä–∏–ª—ë—Ç—É
      const node = getNodeById(nodeId);
      if (!node){
        // –µ—Å–ª–∏ –Ω–µ—Ç (—Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏) ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç—É
        renderMap();
        return;
      }
      openNodeQuiz(node);
    });
  }

  function getNodeById(id){
    if (nodes[id]) return nodes[id];
    if (randomEvents[id]) return randomEvents[id];
    return null;
  }

  function openNodeQuiz(node){
    // –¥–∏–Ω–∞–º–∏–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —É–∑–ª–∞
    if (node.id === "E11"){
      const kind = (state.progress >= 85 && state.stress < 80) ? "good" : (state.stress >= 80 ? "bad" : "warn");
      setTag(kind, node.sector);

      const c1 = {
        label:"–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—ã –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä—ã–∂–æ–∫",
        _action: () => {
          closeQuiz();
          applyDelta(10, 10);
          if (endIfNeeded()) return;

          // –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ R7
          state.pendingReturn = "E11";
          queueNextForced("R7");
        }
      };
      const c2 = {
        label:"–°–¥–µ–ª–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∫–∞–ª–∏–±—Ä–æ–≤–∫—É –ø–µ—Ä–µ–¥ –ø—Ä—ã–∂–∫–æ–º",
        _action: () => {
          closeQuiz();
          applyDelta(5, -5);
          if (endIfNeeded()) return;

          state.pendingReturn = "E11";
          let pick = Object.keys(randomEvents)[rnd(0, Object.keys(randomEvents).length - 1)];
          if (state.flags.audit_risk && chance(0.5)) pick = "R8";
          queueNextForced(pick);
        }
      };

      openQuiz({
        sector: node.sector,
        title: node.title,
        text: node.text,
        choices: [c1, c2]
      }, { kind });
      return;
    }

    const isRandom = node.id.startsWith("R");
    const kind = isRandom ? "warn" : "";
    setTag(kind, node.sector);

    // –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞
    const preparedChoices = (node.choices || []).map(c => {
      return {
        label: c.label,
        _action: () => {
          closeQuiz();

          // fatal
          if (c.fatal){
            applyDelta(0, 100);
            openQuiz({
              sector:"–§–∏–Ω–∞–ª",
              title:"–°–∏—Å—Ç–µ–º—ã –æ—Ç–∫–∞–∑–∞–ª–∏",
              text: c.fatalReason || "–ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞.",
              choices:[{ label:"–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ü–∏–∫–ª", _action: () => resetGame() }]
            }, { kind:"bad" });
            return;
          }

          // flags
          if (c.setFlag){
            for (const [k,v] of Object.entries(c.setFlag)) state.flags[k] = v;
          }

          // probability
          if (c.prob){
            if (chance(c.prob.p)){
              const s = c.prob.success;
              if (s.setFlag) for (const [k,v] of Object.entries(s.setFlag)) state.flags[k] = v;
              if (s.fatal){
                applyDelta(0, 100);
                openQuiz({
                  sector:"–§–∏–Ω–∞–ª",
                  title:"–°–∏—Å—Ç–µ–º—ã –æ—Ç–∫–∞–∑–∞–ª–∏",
                  text: s.fatalReason || "–ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞.",
                  choices:[{ label:"–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ü–∏–∫–ª", _action: () => resetGame() }]
                }, { kind:"bad" });
                return;
              }
              applyDelta(s.dp || 0, s.ds || 0);
              if (endIfNeeded()) return;

              const next = resolveNext(s.next);
              if (next) queueNext(next);
              else queueAfterRandomReturn();
              return;
            } else {
              const f = c.prob.fail;
              if (f.setFlag) for (const [k,v] of Object.entries(f.setFlag)) state.flags[k] = v;
              if (f.fatal){
                applyDelta(0, 100);
                openQuiz({
                  sector:"–§–∏–Ω–∞–ª",
                  title:"–°–∏—Å—Ç–µ–º—ã –æ—Ç–∫–∞–∑–∞–ª–∏",
                  text: f.fatalReason || "–ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞.",
                  choices:[{ label:"–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ü–∏–∫–ª", _action: () => resetGame() }]
                }, { kind:"bad" });
                return;
              }
              applyDelta(f.dp || 0, f.ds || 0);
              if (endIfNeeded()) return;

              const next = resolveNext(f.next);
              if (next) queueNext(next);
              else queueAfterRandomReturn();
              return;
            }
          }

          // plain delta
          applyDelta(c.dp || 0, c.ds || 0);
          if (c.addStressLater) state.flags.audit_risk = true;

          if (endIfNeeded()) return;

          // next
          const next = resolveNext(c.next);
          if (next){
            queueNext(next);
          } else {
            // random events often return to pendingReturn
            queueAfterRandomReturn();
          }
        }
      };
    });

    openQuiz({
      sector: node.sector,
      title: node.title,
      text: node.text,
      choices: preparedChoices
    }, { kind });
  }

  function queueAfterRandomReturn(){
    // –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª–æ —Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –±–µ–∑ —è–≤–Ω–æ–≥–æ next
    const pending = state.pendingReturn;
    state.pendingReturn = null;
    if (pending) queueNext(pending);
    else setAvailable([state.currentNode]); // fallback
  }

  function queueNext(nextId){
    // –í—Å—Ç–∞–≤–∫–∞ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –º–µ–∂–¥—É —É–∑–ª–∞–º–∏ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ), –Ω–æ —Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ ‚Äú–¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞‚Äù
    const injected = maybeInsertRandom(nextId);

    // –µ—Å–ª–∏ –≤—Å—Ç–∞–≤–∏–ª–æ—Å—å —Å–æ–±—ã—Ç–∏–µ, –¥–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º —Ç–æ–ª—å–∫–æ –µ–≥–æ (—á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–Ω—É–ª –∏ ‚Äú–ø–µ—Ä–µ–ª–µ—Ç–µ–ª‚Äù)
    if (injected !== nextId){
      // –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: —Ç–æ–ª—å–∫–æ —Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
      // –Ω–æ –Ω–∞ –∫–∞—Ä—Ç–µ –æ–Ω–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –º–∞—è–∫
      setAvailable([injected]);
      return;
    }

    // –æ–±—ã—á–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥: –¥–æ—Å—Ç—É–ø–µ–Ω –æ–¥–∏–Ω —Å–ª–µ–¥—É—é—â–∏–π —Å–µ–∫—Ç–æ—Ä (–∫–∞–∫ –≤ —Ç–≤–æ–µ–π —Å—é–∂–µ—Ç–∫–µ –ª–∏–Ω–µ–π–Ω–æ)
    setAvailable([nextId]);
  }

  function queueNextForced(id){
    // –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π ‚Äú—Å–ª–µ–¥—É—é—â–∏–π —Å–µ–∫—Ç–æ—Ä‚Äù –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –≤—Å—Ç–∞–≤–∫–∏
    setAvailable([id]);
  }

  // ============
  // MODAL
  // ============
  function openQuiz(payload, { kind="" } = {}){
    setTag(kind, payload.sector || "–°–µ–∫—Ç–æ—Ä");
    ui.qTitle.textContent = payload.title || "";
    ui.qText.textContent = payload.text || "";

    ui.qChoices.innerHTML = "";
    for (const c of (payload.choices || [])){
      const btn = document.createElement("button");
      btn.textContent = c.label;
      btn.addEventListener("click", () => {
        if (c._action) c._action();
      });
      ui.qChoices.appendChild(btn);
    }

    ui.modalBack.style.display = "flex";
  }

  function closeQuiz(){
    ui.modalBack.style.display = "none";
  }

  // close modal on backdrop click (optional)
  ui.modalBack.addEventListener("click", (e) => {
    if (e.target === ui.modalBack) {
      // –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å flow ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤—ã–±—Ä–∞—Ç—å
    }
  });

  // ============
  // RENDER MAP (—Ç–æ–ª—å–∫–æ —Ç–æ—á–∫–∏)
  // ============
  function renderMap(){
    clear(ui.beaconsLayer);
    clear(ui.shipLayer);
    clear(ui.exitLayer);

    // draw exit
    const exitG = diamond(EXIT_POS.x, EXIT_POS.y, "rgba(124,255,124,.95)", 14, "glowB");
    ui.exitLayer.appendChild(exitG);
    ui.exitLayer.appendChild(el("text",{
      x: EXIT_POS.x - 44, y: EXIT_POS.y - 20,
      fill:"rgba(231,240,255,.80)",
      "font-size":"12",
      "font-family":"ui-monospace, Menlo, Consolas, monospace"
    }, "100"));

    // beacons: show all story nodes + possible random nodes
    const allIds = Object.keys(NODE_POS);

    for (const id of allIds){
      const p = NODE_POS[id];
      const isVisited = state.visited.has(id);
      const isAvailable = state.available.has(id);
      const isCurrent = (state.currentNode === id);

      // style
      let color = "rgba(220,235,255,.22)";
      let size = 6;

      if (isVisited) { color = "rgba(220,235,255,.35)"; size = 7; }
      if (isAvailable) { color = "rgba(76,201,240,.95)"; size = 10; }
      if (isCurrent) { color = "rgba(76,201,240,.95)"; size = 9; }

      // ‚Äú—Ç–∏–ø‚Äù —Å–æ–±—ã—Ç–∏–π (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø—Ä–∏—è—Ç–Ω–æ)
      // random events –ø–æ–¥—Å–≤–µ—Ç–∏–º —á—É—Ç—å –∏–Ω–∞—á–µ (–∂–µ–ª—Ç–æ–≤–∞—Ç—ã–π –æ—Ç—Ç–µ–Ω–æ–∫), –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã/–ø–æ—Å–µ—â–µ–Ω—ã
      const node = getNodeById(id);
      const isRandom = node && node.id && node.id.startsWith("R");
      if (isRandom && isAvailable) color = "rgba(255,209,102,.95)";

      const g = diamond(p.x, p.y, color, size, isAvailable ? "glowB" : "glowA");

      // –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
      if (isAvailable && !state.isTraveling){
        g.classList.add("clickable","noSelect");
        g.classList.add("pulse");
        g.setAttribute("tabindex","0");
        g.setAttribute("role","button");
        g.setAttribute("aria-label","–ü–µ—Ä–µ–ª–µ—Ç–µ—Ç—å –≤ —Å–µ–∫—Ç–æ—Ä");
        g.appendChild(el("title", {}, "–ü–µ—Ä–µ–ª–µ—Ç–µ—Ç—å"));

        g.addEventListener("click", (e) => {
          e.stopPropagation();
          travelTo(id);
        });
        g.addEventListener("keydown", (e) => {
          if (e.key === "Enter") travelTo(id);
        });
      } else {
        // –Ω–µ –ª–æ–≤–∏—Ç—å –∫–ª–∏–∫–∏
        g.style.pointerEvents = "none";
      }

      ui.beaconsLayer.appendChild(g);

      // –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Å–µ–∫—Ç–æ—Ä ‚Äî –ª—ë–≥–∫–æ–µ –∫–æ–ª—å—Ü–æ –≤–æ–∫—Ä—É–≥
      if (isCurrent){
        ui.beaconsLayer.appendChild(circle(p.x, p.y, 14, "rgba(76,201,240,.08)", "rgba(76,201,240,.35)", 2, "glowA"));
      }
    }

    drawShip();
  }

  function drawShip(){
    // —Ä–∞–∫–µ—Ç–∞ —Å—Ç–æ–∏—Ç –Ω–∞ —Ç–µ–∫—É—â–µ–º —Å–µ–∫—Ç–æ—Ä–µ
    const p = NODE_POS[state.currentNode] || NODE_POS["E1"];
    const g = el("g", { transform:`translate(${p.x} ${p.y})`, filter:"url(#glowB)" });

    g.appendChild(circle(0,0, 11, "rgba(76,201,240,.18)", "rgba(76,201,240,.70)", 2, null));
    g.appendChild(el("path",{
      d:"M -2 -8 L 12 0 L -2 8 Z",
      fill:"rgba(76,201,240,.95)",
      stroke:"rgba(0,0,0,.35)",
      "stroke-width":"1"
    }));
    g.appendChild(el("text",{
      x:16, y:-10,
      fill:"rgba(231,240,255,.85)",
      "font-size":"12",
      "font-family":"ui-monospace, Menlo, Consolas, monospace"
    }, `${state.progress}%`));

    ui.shipLayer.appendChild(g);
  }

  function animateShip(from, to, ms, done){
    // –ø—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö libs
    const start = performance.now();
    const ease = (t) => (t<0.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2);

    function frame(now){
      const t = clamp((now - start) / ms, 0, 1);
      const k = ease(t);
      const x = from.x + (to.x - from.x) * k;
      const y = from.y + (to.y - from.y) * k;

      clear(ui.shipLayer);
      const g = el("g", { transform:`translate(${x} ${y})`, filter:"url(#glowB)" });
      g.appendChild(circle(0,0, 11, "rgba(76,201,240,.18)", "rgba(76,201,240,.70)", 2));
      g.appendChild(el("path",{
        d:"M -2 -8 L 12 0 L -2 8 Z",
        fill:"rgba(76,201,240,.95)",
        stroke:"rgba(0,0,0,.35)",
        "stroke-width":"1"
      }));
      ui.shipLayer.appendChild(g);

      if (t < 1) requestAnimationFrame(frame);
      else {
        renderMap();
        done();
      }
    }
    requestAnimationFrame(frame);
  }

  // ============
  // RESET
  // ============
  function resetGame(){
    state.progress = 0;
    state.stress = 20;
    state.cycle += 1;
    state.flags = { asteroid_possible:false, fuzzy_requirements:false, audit_risk:false };
    state.stepsSinceRandom = 0;
    state.pendingReturn = null;
    state.currentNode = "E1";
    state.visited = new Set(["E1"]);
    state.available = new Set(["E1"]);
    state.isTraveling = false;

    updateBars();
    closeQuiz();
    renderMap();
  }

  // ============
  // BOOT
  // ============
  updateBars();
  renderMap();

  // –°—Ç–∞—Ä—Ç: –∏–≥—Ä–æ–∫ –∫–ª–∏–∫–∞–µ—Ç –ø–æ E1 (–¥–æ—Å—Ç—É–ø–µ–Ω) -> –ø—Ä–∏–ª–µ—Ç -> –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∫–≤–∏–∑
  // (–ú–æ–∂–Ω–æ –∏ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–æ–º, –Ω–æ —Ç—ã –ø—Ä–æ—Å–∏–ª ‚Äú–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç –Ω–∞ —Å–µ–∫—Ç–æ—Ä‚Äù.)

  // –ö–æ–≥–¥–∞ –∫–≤–∏–∑ E1 –ø—Ä–æ–π–¥–µ–Ω ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–π —Å–µ–∫—Ç–æ—Ä (—á–µ—Ä–µ–∑ setAvailable).

})();
</script>
</body>
</html>
